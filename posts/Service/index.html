<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="prefer-datetime-locale" content="Asia/Jinan"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="JAVA-Socket通信 聊天室（服务端）" /><meta name="author" content="Aye486" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="关于聊天室中服务器部分" /><meta property="og:description" content="关于聊天室中服务器部分" /><link rel="canonical" href="/posts/Service/" /><meta property="og:url" content="/posts/Service/" /><meta property="og:site_name" content="Aye486" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-06-15T13:02:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="JAVA-Socket通信 聊天室（服务端）" /><meta name="twitter:site" content="@Aye486" /><meta name="twitter:creator" content="@Aye486" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Aye486"},"dateModified":"2022-06-17T07:30:52+00:00","datePublished":"2022-06-15T13:02:00+00:00","description":"关于聊天室中服务器部分","headline":"JAVA-Socket通信 聊天室（服务端）","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/Service/"},"url":"/posts/Service/"}</script><title>JAVA-Socket通信 聊天室（服务端） | Aye486</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Aye486"><meta name="application-name" content="Aye486"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/config/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Aye486</a></div><div class="site-subtitle font-italic">这里是Aye486的博客～</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/Aye486" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/Aye486" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['cwy1143','163.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>JAVA-Socket通信 聊天室（服务端）</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>JAVA-Socket通信 聊天室（服务端）</h1><div class="post-meta text-muted"> <span> 发表于 <em class="" data-ts="1655298120" data-df="YYYY-MM-DD" data-toggle="tooltip" data-placement="bottom"> 2022-06-15 </em> </span> <span> 更新于 <em class="" data-ts="1655451052" data-df="YYYY-MM-DD" data-toggle="tooltip" data-placement="bottom"> 2022-06-17 </em> </span><div class="d-flex justify-content-between"> <span> 作者 <em> Aye486 </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3627 字"> <em>20 分钟</em>阅读</span></div></div></div><div class="post-content"><h1 id="关于聊天室中服务器部分">关于聊天室中服务器部分</h1><p>一个聊天室，我们可以将其分为服务端和客户端，而通信的简易过程如下图所示</p><p><img data-src="/assets/blog_res/2022-06-16-Service.assets/%E6%97%A0%E6%A0%87%E9%A2%98.png" style="zoom:200%;" data-proofer-ignore></p><p>对于服务器，我们需要做的是1、验证用户登陆信息。2、接收用户发送的信息并转发给目标用户</p><h1 id="整体思路">整体思路</h1><h2 id="server端"><span class="mr-2">Server端</span><a href="#server端" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><img data-src="/assets/blog_res/2022-06-16-Service.assets/image-20220617112109334.png" alt="image-20220617112109334" data-proofer-ignore></p><h3 id="userservice"><span class="mr-2">UserService</span><a href="#userservice" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>用于用户账号管理，预先创建几个账号，然后存到文件中，每次服务器执行时，都会将文件中的账号信息读入，同时新创建的用户账号也会存入到文件中去。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserService</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">idCount</span> <span class="o">=</span><span class="mi">3</span><span class="o">;</span><span class="c1">//id</span>
    <span class="c1">//新增用户</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addUser</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">){</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setId</span><span class="o">(++</span><span class="n">idCount</span><span class="o">);</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">loadAllUser</span><span class="o">();</span>
        <span class="n">users</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="n">saveAllUser</span><span class="o">(</span><span class="n">users</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//用户登录</span>
    <span class="kd">public</span> <span class="nc">User</span> <span class="nf">login</span><span class="o">(</span><span class="kt">long</span> <span class="n">id</span><span class="o">,</span><span class="nc">String</span> <span class="n">password</span><span class="o">){</span>
        <span class="nc">User</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span><span class="n">loadAllUser</span><span class="o">();</span>
        <span class="k">for</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span> <span class="o">:</span> <span class="n">users</span><span class="o">){</span>
            <span class="k">if</span><span class="o">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">()&amp;&amp;</span><span class="n">password</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getPassword</span><span class="o">())){</span>
                <span class="n">result</span><span class="o">=</span><span class="n">user</span><span class="o">;</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">//根据ID加载用户</span>
    <span class="kd">public</span> <span class="nc">User</span> <span class="nf">loadUser</span><span class="o">(</span><span class="kt">long</span> <span class="n">id</span><span class="o">){</span>
        <span class="nc">User</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">users</span><span class="o">=</span><span class="n">loadAllUser</span><span class="o">();</span>
        <span class="k">for</span><span class="o">(</span><span class="nc">User</span> <span class="nl">user:</span><span class="n">users</span><span class="o">){</span>
            <span class="k">if</span><span class="o">(</span><span class="n">id</span><span class="o">==</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">()){</span>
                <span class="n">result</span><span class="o">=</span><span class="n">user</span><span class="o">;</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">//加载所有用户</span>
    <span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">loadAllUser</span><span class="o">(){</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">ObjectInputStream</span> <span class="n">ois</span> <span class="o">=</span><span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">ois</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectInputStream</span><span class="o">(</span>
                    <span class="k">new</span> <span class="nf">FileInputStream</span><span class="o">(</span>
                            <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">configProp</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"dbpath"</span><span class="o">)));</span>
            <span class="n">list</span> <span class="o">=(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;)</span> <span class="n">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
            <span class="nc">IOUtil</span><span class="o">.</span><span class="na">close</span><span class="o">(</span><span class="n">ois</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">list</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="c1">//保存所有用户</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">saveAllUser</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">users</span><span class="o">){</span>
        <span class="nc">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span><span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectOutputStream</span><span class="o">(</span>
                    <span class="k">new</span> <span class="nf">FileOutputStream</span><span class="o">(</span>
                            <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">configProp</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"dbpath"</span><span class="o">)));</span>
            <span class="c1">//写回用户信息</span>
            <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">users</span><span class="o">);</span>
            <span class="n">oos</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
            <span class="nc">IOUtil</span><span class="o">.</span><span class="na">close</span><span class="o">(</span><span class="n">oos</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">//初始化几个测试用户</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initUser</span><span class="o">(){</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">(</span><span class="s">"admin"</span><span class="o">,</span> <span class="s">"Admin"</span><span class="o">,</span> <span class="sc">'m'</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>

        <span class="nc">User</span> <span class="n">user2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">(</span><span class="s">"123456"</span><span class="o">,</span> <span class="s">"Tom"</span><span class="o">,</span> <span class="sc">'m'</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
        <span class="n">user2</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>

        <span class="nc">User</span> <span class="n">user3</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">(</span><span class="s">"123456"</span><span class="o">,</span> <span class="s">"Lily"</span><span class="o">,</span> <span class="sc">'f'</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
        <span class="n">user3</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>

        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CopyOnWriteArrayList</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;();</span>
        <span class="n">users</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="n">users</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">user2</span><span class="o">);</span>
        <span class="n">users</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">user3</span><span class="o">);</span>

        <span class="k">this</span><span class="o">.</span><span class="na">saveAllUser</span><span class="o">(</span><span class="n">users</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">){</span>
        <span class="k">new</span> <span class="nf">UserService</span><span class="o">().</span><span class="na">initUser</span><span class="o">();</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UserService</span><span class="o">().</span><span class="na">loadAllUser</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">User</span> <span class="n">user</span> <span class="o">:</span> <span class="n">users</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="databuffer"><span class="mr-2">DataBuffer</span><a href="#databuffer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>用于服务器端从文件中读取数据，进行缓存</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DataBuffer</span> <span class="o">{</span>
    <span class="c1">// 服务器端socket</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">ServerSocket</span> <span class="n">serverSocket</span><span class="o">;</span>
    <span class="c1">//在线用户的IO Map</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">,</span><span class="nc">OnlineClientIOCache</span><span class="o">&gt;</span> <span class="n">onlineUserIOCacheMap</span><span class="o">;</span>
    <span class="c1">//在线用户Map</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">,</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">onlineUsersMap</span><span class="o">;</span>
    <span class="c1">//服务器配置参数属性集</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Properties</span> <span class="n">configProp</span><span class="o">;</span>
    <span class="c1">//已注册用户表的Model</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">RegistedUserTableModel</span> <span class="n">registedUserTableModel</span><span class="o">;</span>
    <span class="c1">// 当前在线用户表的Model</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">OnlineUserTableModel</span> <span class="n">onlineUserTableModel</span><span class="o">;</span>
    <span class="c1">// 当前服务器所在系统的屏幕尺寸</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Dimension</span> <span class="n">screenSize</span><span class="o">;</span>
    <span class="c1">// 当前用户数据库</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">UserService</span> <span class="n">userService</span><span class="o">;</span>
    <span class="kd">static</span><span class="o">{</span>
        <span class="c1">// 初始化</span>
        <span class="c1">//ConcurrentSkipListMap: 线程安全的有序的哈希表 适用于高并发的场景</span>
        <span class="n">onlineUserIOCacheMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentSkipListMap</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">,</span> <span class="nc">OnlineClientIOCache</span><span class="o">&gt;();</span> <span class="c1">//在线用户的IO缓存map</span>
        <span class="n">onlineUsersMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentSkipListMap</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">,</span> <span class="nc">User</span><span class="o">&gt;();</span> <span class="c1">//在线用户map</span>
        <span class="n">configProp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Properties</span><span class="o">();</span> <span class="c1">//创建配置文件</span>
        <span class="n">registedUserTableModel</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RegistedUserTableModel</span><span class="o">();</span> <span class="c1">//初始化几个已注册用户</span>
        <span class="n">onlineUserTableModel</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OnlineUserTableModel</span><span class="o">();</span> <span class="c1">//获取在线用户</span>
        <span class="n">screenSize</span> <span class="o">=</span> <span class="nc">Toolkit</span><span class="o">.</span><span class="na">getDefaultToolkit</span><span class="o">().</span><span class="na">getScreenSize</span><span class="o">();</span> <span class="c1">//获取屏幕尺寸</span>
        <span class="n">userService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UserService</span><span class="o">();</span> <span class="c1">//创建服务器</span>

        <span class="c1">// 加载服务器配置文件</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">configProp</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">getContextClassLoader</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">"serverconfig.properties"</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="requestprocessor"><span class="mr-2">RequestProcessor</span><a href="#requestprocessor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>这时服务器端最重要的一个类了，用于处理客户端发来的消息，并进行回复，对于每一项操作的实现原理无非就是服务器处理内部数据或是向指定客户端发送消息，详细看代码注释</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
</pre><td class="rouge-code"><pre><span class="c1">//针对每个用户的服务线程</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RequestProcessor</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
    <span class="c1">//当前正在请求服务器的客户端Socket</span>
    <span class="kd">private</span> <span class="nc">Socket</span> <span class="n">currentClientSocket</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nf">RequestProcessor</span><span class="o">(</span><span class="nc">Socket</span> <span class="n">currentClientSocket</span><span class="o">){</span>
        <span class="k">this</span><span class="o">.</span><span class="na">currentClientSocket</span><span class="o">=</span><span class="n">currentClientSocket</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
        <span class="kt">boolean</span> <span class="n">flag</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span><span class="c1">//是否不断监听</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="nc">OnlineClientIOCache</span> <span class="n">currentClientIOCache</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OnlineClientIOCache</span><span class="o">(</span>
                    <span class="k">new</span> <span class="nf">ObjectInputStream</span><span class="o">(</span><span class="n">currentClientSocket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">()),</span>
                    <span class="k">new</span> <span class="nf">ObjectOutputStream</span><span class="o">(</span><span class="n">currentClientSocket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">()));</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">flag</span><span class="o">){</span>
                <span class="c1">//不停地读取客户端发过来的请求对象</span>
                <span class="c1">//从请求输入流中读取到客户端提交的请求对象</span>
                <span class="nc">Request</span> <span class="n">request</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Request</span><span class="o">)</span><span class="n">currentClientIOCache</span><span class="o">.</span><span class="na">getOis</span><span class="o">().</span><span class="na">readObject</span><span class="o">();</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Server读取了客户端的请求:"</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="na">getAction</span><span class="o">());</span>
                <span class="c1">//获取请求中的动作</span>
                <span class="nc">String</span> <span class="n">actionName</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getAction</span><span class="o">();</span>
                <span class="k">if</span><span class="o">(</span><span class="n">actionName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"userRegist"</span><span class="o">)){</span>      <span class="c1">//用户注册</span>
                    <span class="n">regist</span><span class="o">(</span><span class="n">currentClientIOCache</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>
                <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">actionName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"userLogin"</span><span class="o">)){</span>  <span class="c1">//用户登录</span>
                    <span class="n">login</span><span class="o">(</span><span class="n">currentClientIOCache</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>
                <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="s">"exit"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">actionName</span><span class="o">)){</span>       <span class="c1">//请求断开连接</span>
                    <span class="n">flag</span> <span class="o">=</span> <span class="n">logout</span><span class="o">(</span><span class="n">currentClientIOCache</span><span class="o">,</span> <span class="n">request</span><span class="o">);</span>
                <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="s">"chat"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">actionName</span><span class="o">)){</span>       <span class="c1">//聊天</span>
                    <span class="n">chat</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
                <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="s">"toSendFile"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">actionName</span><span class="o">)){</span> <span class="c1">//准备发送文件</span>
                    <span class="n">toSendFile</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
                <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="s">"agreeReceiveFile"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">actionName</span><span class="o">)){</span> <span class="c1">//同意接收文件</span>
                    <span class="n">agreeReceiveFile</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
                <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="s">"refuseReceiveFile"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">actionName</span><span class="o">)){</span> <span class="c1">//拒绝接收文件</span>
                    <span class="n">refuseReceiveFile</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">//注册</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">regist</span><span class="o">(</span><span class="nc">OnlineClientIOCache</span> <span class="n">oio</span><span class="o">,</span><span class="nc">Request</span> <span class="n">request</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">{</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="o">(</span><span class="nc">User</span><span class="o">)</span><span class="n">request</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"user"</span><span class="o">);</span>
        <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">userService</span><span class="o">.</span><span class="na">addUser</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="c1">//创建一个响应对象</span>
        <span class="nc">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Response</span><span class="o">();</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="nc">ResponseStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="s">"user"</span><span class="o">,</span><span class="n">user</span><span class="o">);</span>
        <span class="c1">//向客户端写入响应对象</span>
        <span class="n">oio</span><span class="o">.</span><span class="na">getOos</span><span class="o">().</span><span class="na">writeObject</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
        <span class="n">oio</span><span class="o">.</span><span class="na">getOos</span><span class="o">().</span><span class="na">flush</span><span class="o">();</span>
        <span class="c1">//把新注册用户添加到RegistedUserTableModel中</span>
        <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">registedUserTableModel</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span>
                <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">()),</span>
                <span class="n">user</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span>
                <span class="n">user</span><span class="o">.</span><span class="na">getNickname</span><span class="o">(),</span>
                <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getSex</span><span class="o">())});</span>
    <span class="o">}</span>

    <span class="c1">//登录</span>
    <span class="kt">void</span> <span class="nf">login</span><span class="o">(</span><span class="nc">OnlineClientIOCache</span> <span class="n">currentClientIO</span><span class="o">,</span> <span class="nc">Request</span> <span class="n">request</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="c1">//获取输入的账号密码</span>
        <span class="nc">String</span> <span class="n">idStr</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span><span class="n">request</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"id"</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">password</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">request</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"password"</span><span class="o">);</span>
        <span class="c1">//建立服务对象</span>
        <span class="nc">UserService</span> <span class="n">userService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UserService</span><span class="o">();</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">login</span><span class="o">(</span><span class="nc">Long</span><span class="o">.</span><span class="na">parseLong</span><span class="o">(</span><span class="n">idStr</span><span class="o">),</span> <span class="n">password</span><span class="o">);</span>

        <span class="nc">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Response</span><span class="o">();</span>  <span class="c1">//创建一个响应对象</span>
        <span class="k">if</span><span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">user</span><span class="o">){</span>
            <span class="k">if</span><span class="o">(</span><span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUsersMap</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">())){</span> <span class="c1">//用户已经登录了</span>
                <span class="n">response</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="nc">ResponseStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">);</span>
                <span class="n">response</span><span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="s">"msg"</span><span class="o">,</span> <span class="s">"该用户已经在别处上线了！"</span><span class="o">);</span>
                <span class="n">currentClientIO</span><span class="o">.</span><span class="na">getOos</span><span class="o">().</span><span class="na">writeObject</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>  <span class="c1">//把响应对象往客户端写</span>
                <span class="n">currentClientIO</span><span class="o">.</span><span class="na">getOos</span><span class="o">().</span><span class="na">flush</span><span class="o">();</span>
            <span class="o">}</span><span class="k">else</span> <span class="o">{</span> <span class="c1">//正确登录</span>
                <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUsersMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">user</span><span class="o">);</span> <span class="c1">//添加到在线用户</span>

                <span class="c1">//设置在线用户</span>
                <span class="n">response</span><span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="s">"onlineUsers"</span><span class="o">,</span>
                        <span class="k">new</span> <span class="nc">CopyOnWriteArrayList</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;(</span><span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUsersMap</span><span class="o">.</span><span class="na">values</span><span class="o">()));</span>

                <span class="n">response</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="nc">ResponseStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">);</span>
                <span class="n">response</span><span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="s">"user"</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
                <span class="n">currentClientIO</span><span class="o">.</span><span class="na">getOos</span><span class="o">().</span><span class="na">writeObject</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>  <span class="c1">//把响应对象往客户端写</span>
                <span class="n">currentClientIO</span><span class="o">.</span><span class="na">getOos</span><span class="o">().</span><span class="na">flush</span><span class="o">();</span>

                <span class="c1">//通知其它用户有人上线了</span>
                <span class="nc">Response</span> <span class="n">response2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Response</span><span class="o">();</span>
                <span class="n">response2</span><span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="nc">ResponseType</span><span class="o">.</span><span class="na">LOGIN</span><span class="o">);</span>
                <span class="n">response2</span><span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="s">"loginUser"</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
                <span class="n">iteratorResponse</span><span class="o">(</span><span class="n">response2</span><span class="o">);</span>

                <span class="c1">//把当前上线的用户IO添加到缓存Map中</span>
                <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUserIOCacheMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span><span class="n">currentClientIO</span><span class="o">);</span>

                <span class="c1">//把当前上线用户添加到OnlineUserTableModel中</span>
                <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUserTableModel</span><span class="o">.</span><span class="na">add</span><span class="o">(</span>
                        <span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">()),</span>
                                <span class="n">user</span><span class="o">.</span><span class="na">getNickname</span><span class="o">(),</span>
                                <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getSex</span><span class="o">())});</span>
            <span class="o">}</span>
        <span class="o">}</span><span class="k">else</span><span class="o">{</span> <span class="c1">//登录失败</span>
            <span class="n">response</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="nc">ResponseStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">);</span>
            <span class="n">response</span><span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="s">"msg"</span><span class="o">,</span> <span class="s">"账号或密码不正确！"</span><span class="o">);</span>
            <span class="n">currentClientIO</span><span class="o">.</span><span class="na">getOos</span><span class="o">().</span><span class="na">writeObject</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
            <span class="n">currentClientIO</span><span class="o">.</span><span class="na">getOos</span><span class="o">().</span><span class="na">flush</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">//用户退出</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">logout</span><span class="o">(</span><span class="nc">OnlineClientIOCache</span> <span class="n">oio</span><span class="o">,</span> <span class="nc">Request</span> <span class="n">request</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">currentClientSocket</span><span class="o">.</span><span class="na">getInetAddress</span><span class="o">().</span><span class="na">getHostAddress</span><span class="o">()</span>
                <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">currentClientSocket</span><span class="o">.</span><span class="na">getPort</span><span class="o">()</span> <span class="o">+</span> <span class="s">"走了"</span><span class="o">);</span>

        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="o">(</span><span class="nc">User</span><span class="o">)</span><span class="n">request</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"user"</span><span class="o">);</span>
        <span class="c1">//把当前在线客户端的IO从Map中删除</span>
        <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUserIOCacheMap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="c1">//从在线用户缓存Map中删除当前用户</span>
        <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUsersMap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>

        <span class="nc">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Response</span><span class="o">();</span>  <span class="c1">//创建一个响应对象</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="nc">ResponseType</span><span class="o">.</span><span class="na">LOGOUT</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="s">"logoutUser"</span><span class="o">,</span> <span class="n">user</span><span class="o">);</span>
        <span class="n">oio</span><span class="o">.</span><span class="na">getOos</span><span class="o">().</span><span class="na">writeObject</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>  <span class="c1">//把响应对象往客户端写</span>
        <span class="n">oio</span><span class="o">.</span><span class="na">getOos</span><span class="o">().</span><span class="na">flush</span><span class="o">();</span>
        <span class="n">currentClientSocket</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>  <span class="c1">//关闭这个客户端Socket</span>

        <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUserTableModel</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span> <span class="c1">//把当前下线用户从在线用户表Model中删除</span>
        <span class="n">iteratorResponse</span><span class="o">(</span><span class="n">response</span><span class="o">);</span> <span class="c1">//通知所有其它在线客户端</span>

        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>  <span class="c1">//断开监听</span>
    <span class="o">}</span>
    <span class="c1">//聊天</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">chat</span><span class="o">(</span><span class="nc">Request</span> <span class="n">request</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="c1">//获取消息内容</span>
        <span class="nc">Message</span> <span class="n">msg</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Message</span><span class="o">)</span><span class="n">request</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"msg"</span><span class="o">);</span>
        <span class="c1">//创建响应对象</span>
        <span class="nc">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Response</span><span class="o">();</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="nc">ResponseStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="nc">ResponseType</span><span class="o">.</span><span class="na">CHAT</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="s">"txtMsg"</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>

        <span class="k">if</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getToUser</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span> <span class="c1">//私聊:只给私聊的对象返回响应</span>
            <span class="nc">OnlineClientIOCache</span> <span class="n">io</span> <span class="o">=</span> <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUserIOCacheMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getToUser</span><span class="o">().</span><span class="na">getId</span><span class="o">());</span>
            <span class="n">sendResponse</span><span class="o">(</span><span class="n">io</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span><span class="o">{</span>  <span class="c1">//群聊:给除了发消息的所有客户端都返回响应</span>
            <span class="k">for</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span> <span class="o">:</span> <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUserIOCacheMap</span><span class="o">.</span><span class="na">keySet</span><span class="o">()){</span>
                <span class="k">if</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getFromUser</span><span class="o">().</span><span class="na">getId</span><span class="o">()</span> <span class="o">==</span> <span class="n">id</span> <span class="o">){</span>  <span class="k">continue</span><span class="o">;</span> <span class="o">}</span>
                <span class="n">sendResponse</span><span class="o">(</span><span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUserIOCacheMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">id</span><span class="o">),</span> <span class="n">response</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">//服务器广播</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">board</span><span class="o">(</span><span class="nc">String</span> <span class="n">str</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="c1">//用户admin做为消息发送者</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="s">"admin"</span><span class="o">);</span>
        <span class="nc">Message</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Message</span><span class="o">();</span>
        <span class="n">msg</span><span class="o">.</span><span class="na">setFromUser</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="n">msg</span><span class="o">.</span><span class="na">setSendTime</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>

        <span class="nc">DateFormat</span> <span class="n">df</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SimpleDateFormat</span><span class="o">(</span><span class="s">"HH:mm:ss"</span><span class="o">);</span>
        <span class="nc">StringBuffer</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuffer</span><span class="o">();</span>
        <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">" "</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">df</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getSendTime</span><span class="o">())).</span><span class="na">append</span><span class="o">(</span><span class="s">" "</span><span class="o">);</span>
        <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"系统通知\n  "</span><span class="o">+</span><span class="n">str</span><span class="o">+</span><span class="s">"\n"</span><span class="o">);</span>
        <span class="n">msg</span><span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="c1">//创建响应对象</span>
        <span class="nc">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Response</span><span class="o">();</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="nc">ResponseStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="nc">ResponseType</span><span class="o">.</span><span class="na">BOARD</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="s">"txtMsg"</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>
        <span class="c1">//向每个在线用户返回响应</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Long</span> <span class="n">id</span> <span class="o">:</span> <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUserIOCacheMap</span><span class="o">.</span><span class="na">keySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">sendResponse_sys</span><span class="o">(</span><span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUserIOCacheMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">id</span><span class="o">),</span> <span class="n">response</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">//服务器踢除用户</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">(</span><span class="nc">User</span> <span class="n">user_</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">{</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="s">"admin"</span><span class="o">);</span>
        <span class="nc">Message</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Message</span><span class="o">();</span>
        <span class="n">msg</span><span class="o">.</span><span class="na">setFromUser</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="n">msg</span><span class="o">.</span><span class="na">setSendTime</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>
        <span class="n">msg</span><span class="o">.</span><span class="na">setToUser</span><span class="o">(</span><span class="n">user_</span><span class="o">);</span>

        <span class="nc">StringBuffer</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuffer</span><span class="o">();</span>
        <span class="nc">DateFormat</span> <span class="n">df</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SimpleDateFormat</span><span class="o">(</span><span class="s">"HH:mm:ss"</span><span class="o">);</span>
        <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">" "</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">df</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getSendTime</span><span class="o">())).</span><span class="na">append</span><span class="o">(</span><span class="s">" "</span><span class="o">);</span>
        <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"系统通知您\n  "</span><span class="o">+</span><span class="s">"您被强制下线"</span><span class="o">+</span><span class="s">"\n"</span><span class="o">);</span>
        <span class="n">msg</span><span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>

        <span class="nc">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Response</span><span class="o">();</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="nc">ResponseStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="nc">ResponseType</span><span class="o">.</span><span class="na">REMOVE</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="s">"txtMsg"</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>

        <span class="nc">OnlineClientIOCache</span> <span class="n">io</span> <span class="o">=</span> <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUserIOCacheMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getToUser</span><span class="o">().</span><span class="na">getId</span><span class="o">());</span>
        <span class="n">sendResponse_sys</span><span class="o">(</span><span class="n">io</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//服务器发送私信</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">chat_sys</span><span class="o">(</span><span class="nc">String</span> <span class="n">str</span><span class="o">,</span><span class="nc">User</span> <span class="n">user_</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">{</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="s">"admin"</span><span class="o">);</span>
        <span class="nc">Message</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Message</span><span class="o">();</span>
        <span class="n">msg</span><span class="o">.</span><span class="na">setFromUser</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="n">msg</span><span class="o">.</span><span class="na">setSendTime</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>
        <span class="n">msg</span><span class="o">.</span><span class="na">setToUser</span><span class="o">(</span><span class="n">user_</span><span class="o">);</span>

        <span class="nc">DateFormat</span> <span class="n">df</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SimpleDateFormat</span><span class="o">(</span><span class="s">"HH:mm:ss"</span><span class="o">);</span>
        <span class="nc">StringBuffer</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuffer</span><span class="o">();</span>
        <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">" "</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">df</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getSendTime</span><span class="o">())).</span><span class="na">append</span><span class="o">(</span><span class="s">" "</span><span class="o">);</span>
        <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"系统通知您\n  "</span><span class="o">+</span><span class="n">str</span><span class="o">+</span><span class="s">"\n"</span><span class="o">);</span>
        <span class="n">msg</span><span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>

        <span class="nc">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Response</span><span class="o">();</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="nc">ResponseStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="nc">ResponseType</span><span class="o">.</span><span class="na">CHAT</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="s">"txtMsg"</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>

        <span class="nc">OnlineClientIOCache</span> <span class="n">io</span> <span class="o">=</span> <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUserIOCacheMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getToUser</span><span class="o">().</span><span class="na">getId</span><span class="o">());</span>
        <span class="n">sendResponse_sys</span><span class="o">(</span><span class="n">io</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//拒绝接收文件</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">refuseReceiveFile</span><span class="o">(</span><span class="nc">Request</span> <span class="n">request</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">FileInfo</span> <span class="n">sendFile</span> <span class="o">=</span> <span class="o">(</span><span class="nc">FileInfo</span><span class="o">)</span><span class="n">request</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"sendFile"</span><span class="o">);</span>
        <span class="nc">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Response</span><span class="o">();</span>  <span class="c1">//创建一个响应对象</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="nc">ResponseType</span><span class="o">.</span><span class="na">REFUSERECEIVEFILE</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="s">"sendFile"</span><span class="o">,</span> <span class="n">sendFile</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="nc">ResponseStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">);</span>
        <span class="c1">//向请求方的输出流输出响应</span>
        <span class="nc">OnlineClientIOCache</span> <span class="n">ocic</span> <span class="o">=</span> <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUserIOCacheMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">sendFile</span><span class="o">.</span><span class="na">getFromUser</span><span class="o">().</span><span class="na">getId</span><span class="o">());</span>
        <span class="k">this</span><span class="o">.</span><span class="na">sendResponse</span><span class="o">(</span><span class="n">ocic</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//同意接收文件</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">agreeReceiveFile</span><span class="o">(</span><span class="nc">Request</span> <span class="n">request</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">FileInfo</span> <span class="n">sendFile</span> <span class="o">=</span> <span class="o">(</span><span class="nc">FileInfo</span><span class="o">)</span><span class="n">request</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"sendFile"</span><span class="o">);</span>
        <span class="c1">//向请求方(文件发送方)的输出流输出响应</span>
        <span class="nc">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Response</span><span class="o">();</span>  <span class="c1">//创建一个响应对象</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="nc">ResponseType</span><span class="o">.</span><span class="na">AGREERECEIVEFILE</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="s">"sendFile"</span><span class="o">,</span> <span class="n">sendFile</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="nc">ResponseStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">);</span>
        <span class="nc">OnlineClientIOCache</span> <span class="n">sendIO</span> <span class="o">=</span> <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUserIOCacheMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">sendFile</span><span class="o">.</span><span class="na">getFromUser</span><span class="o">().</span><span class="na">getId</span><span class="o">());</span>
        <span class="k">this</span><span class="o">.</span><span class="na">sendResponse</span><span class="o">(</span><span class="n">sendIO</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>

        <span class="c1">//向文件接收方发出接收文件的响应</span>
        <span class="nc">Response</span> <span class="n">response2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Response</span><span class="o">();</span>  <span class="c1">//创建一个响应对象</span>
        <span class="n">response2</span><span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="nc">ResponseType</span><span class="o">.</span><span class="na">RECEIVEFILE</span><span class="o">);</span>
        <span class="n">response2</span><span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="s">"sendFile"</span><span class="o">,</span> <span class="n">sendFile</span><span class="o">);</span>
        <span class="n">response2</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="nc">ResponseStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">);</span>
        <span class="nc">OnlineClientIOCache</span> <span class="n">receiveIO</span> <span class="o">=</span> <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUserIOCacheMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">sendFile</span><span class="o">.</span><span class="na">getToUser</span><span class="o">().</span><span class="na">getId</span><span class="o">());</span>
        <span class="k">this</span><span class="o">.</span><span class="na">sendResponse</span><span class="o">(</span><span class="n">receiveIO</span><span class="o">,</span> <span class="n">response2</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 准备发送文件</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">toSendFile</span><span class="o">(</span><span class="nc">Request</span> <span class="n">request</span><span class="o">)</span><span class="kd">throws</span> <span class="nc">IOException</span><span class="o">{</span>
        <span class="nc">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Response</span><span class="o">();</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="nc">ResponseStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="nc">ResponseType</span><span class="o">.</span><span class="na">TOSENDFILE</span><span class="o">);</span>
        <span class="nc">FileInfo</span> <span class="n">sendFile</span> <span class="o">=</span> <span class="o">(</span><span class="nc">FileInfo</span><span class="o">)</span><span class="n">request</span><span class="o">.</span><span class="na">getAttribute</span><span class="o">(</span><span class="s">"file"</span><span class="o">);</span>
        <span class="n">response</span><span class="o">.</span><span class="na">setData</span><span class="o">(</span><span class="s">"sendFile"</span><span class="o">,</span> <span class="n">sendFile</span><span class="o">);</span>
        <span class="c1">//给文件接收方转发文件发送方的请求</span>
        <span class="nc">OnlineClientIOCache</span> <span class="n">ioCache</span> <span class="o">=</span> <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUserIOCacheMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">sendFile</span><span class="o">.</span><span class="na">getToUser</span><span class="o">().</span><span class="na">getId</span><span class="o">());</span>
        <span class="n">sendResponse</span><span class="o">(</span><span class="n">ioCache</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//向指定客户端IO的输出流中输出指定响应</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">sendResponse</span><span class="o">(</span><span class="nc">OnlineClientIOCache</span> <span class="n">onlineUserIO</span><span class="o">,</span> <span class="nc">Response</span> <span class="n">response</span><span class="o">)</span><span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="n">onlineUserIO</span><span class="o">.</span><span class="na">getOos</span><span class="o">();</span>
        <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
        <span class="n">oos</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// 向指定客户端IO的输出流中输出指定响应</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">sendResponse_sys</span><span class="o">(</span><span class="nc">OnlineClientIOCache</span> <span class="n">onlineUserIO</span><span class="o">,</span> <span class="nc">Response</span> <span class="n">response</span><span class="o">)</span><span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="n">onlineUserIO</span><span class="o">.</span><span class="na">getOos</span><span class="o">();</span>
        <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
        <span class="n">oos</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">//给所有在线客户都发送响应</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">iteratorResponse</span><span class="o">(</span><span class="nc">Response</span> <span class="n">response</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">for</span><span class="o">(</span><span class="nc">OnlineClientIOCache</span> <span class="n">onlineUserIO</span> <span class="o">:</span> <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUserIOCacheMap</span><span class="o">.</span><span class="na">values</span><span class="o">()){</span>
            <span class="nc">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="n">onlineUserIO</span><span class="o">.</span><span class="na">getOos</span><span class="o">();</span>
            <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
            <span class="n">oos</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></table></code></div></div><h3 id="serverinfogui"><span class="mr-2">ServerInfoGUI</span><a href="#serverinfogui" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>界面大致形状</p><p><img data-src="/assets/blog_res/2022-06-16-Service.assets/1.png" alt="1" data-proofer-ignore></p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServerInfoFrame</span> <span class="kd">extends</span> <span class="nc">JFrame</span><span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">6274443611957724780L</span><span class="o">;</span>
    <span class="c1">//发送信息输入窗口</span>
    <span class="kd">private</span> <span class="nc">JTextField</span> <span class="n">jta_msg</span><span class="o">;</span>
    <span class="c1">//在线用户表</span>
    <span class="kd">private</span> <span class="nc">JTable</span> <span class="n">onlineUserTable</span><span class="o">;</span>
    <span class="c1">//已注册用户表</span>
    <span class="kd">private</span> <span class="nc">JTable</span> <span class="n">registedUserTable</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ServerInfoFrame</span><span class="o">(){</span>
        <span class="n">init</span><span class="o">();</span>
        <span class="n">loadData</span><span class="o">();</span>
        <span class="n">setVisible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//初始化窗体</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(){</span>
        <span class="k">this</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="s">"服务器启动"</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">setBounds</span><span class="o">((</span><span class="nc">DataBuffer</span><span class="o">.</span><span class="na">screenSize</span><span class="o">.</span><span class="na">width</span> <span class="o">-</span> <span class="mi">700</span><span class="o">)/</span><span class="mi">2</span><span class="o">,</span>
                <span class="o">(</span><span class="nc">DataBuffer</span><span class="o">.</span><span class="na">screenSize</span><span class="o">.</span><span class="na">height</span> <span class="o">-</span> <span class="mi">475</span><span class="o">)/</span><span class="mi">2</span><span class="o">,</span> <span class="mi">700</span><span class="o">,</span> <span class="mi">475</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">setLayout</span><span class="o">(</span><span class="k">new</span> <span class="nc">BorderLayout</span><span class="o">());</span>

        <span class="nc">JPanel</span> <span class="n">panel</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JPanel</span><span class="o">();</span>
        <span class="nc">Border</span> <span class="n">border</span><span class="o">=</span><span class="nc">BorderFactory</span><span class="o">.</span><span class="na">createEtchedBorder</span><span class="o">(</span><span class="nc">EtchedBorder</span><span class="o">.</span><span class="na">LOWERED</span><span class="o">);</span>
        <span class="n">panel</span><span class="o">.</span><span class="na">setBorder</span><span class="o">(</span><span class="nc">BorderFactory</span><span class="o">.</span><span class="na">createTitledBorder</span><span class="o">(</span><span class="n">border</span><span class="o">,</span><span class="s">"服务器监听中"</span><span class="o">,</span><span class="nc">TitledBorder</span><span class="o">.</span><span class="na">LEFT</span><span class="o">,</span><span class="nc">TitledBorder</span><span class="o">.</span><span class="na">TOP</span><span class="o">));</span>
        <span class="k">this</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">panel</span><span class="o">,</span><span class="nc">BorderLayout</span><span class="o">.</span><span class="na">NORTH</span><span class="o">);</span>

        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="nc">DataBuffer</span><span class="o">.</span><span class="na">configProp</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"port"</span><span class="o">));</span>

        <span class="nc">JLabel</span> <span class="n">label</span> <span class="o">=</span><span class="k">new</span> <span class="nc">JLabel</span><span class="o">(</span><span class="s">"服务器端口：\n"</span><span class="o">+</span><span class="n">port</span><span class="o">);</span>
        <span class="n">panel</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">label</span><span class="o">);</span>
        <span class="nc">JButton</span> <span class="n">exitBtn</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JButton</span><span class="o">(</span><span class="s">"关闭服务器"</span><span class="o">);</span>
        <span class="n">panel</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">exitBtn</span><span class="o">);</span>

        <span class="nc">JLabel</span> <span class="n">la_msg</span> <span class="o">=</span><span class="k">new</span> <span class="nc">JLabel</span><span class="o">(</span><span class="s">"要发送的消息"</span><span class="o">);</span>
        <span class="n">panel</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">la_msg</span><span class="o">);</span>
        <span class="c1">//服务器要发送消息的输入框</span>
        <span class="n">jta_msg</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JTextField</span><span class="o">(</span><span class="mi">30</span><span class="o">);</span>
        <span class="c1">//定义一个监听器对象：发送广播消息</span>
        <span class="nc">ActionListener</span> <span class="n">sendCaseMsgAction</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActionListener</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">actionPerformed</span><span class="o">(</span><span class="nc">ActionEvent</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span><span class="o">{</span>
                    <span class="n">sendAllMsg</span><span class="o">();</span>
                <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e1</span><span class="o">){</span>
                    <span class="n">e1</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">};</span>
        <span class="c1">//给输入框加上事件监听器，按回车发送；</span>
        <span class="n">jta_msg</span><span class="o">.</span><span class="na">addActionListener</span><span class="o">(</span><span class="n">sendCaseMsgAction</span><span class="o">);</span>
        <span class="nc">JButton</span> <span class="n">bu_send</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JButton</span><span class="o">(</span><span class="s">"send"</span><span class="o">);</span>
        <span class="c1">//给按钮加上发送广播消息的监听器</span>
        <span class="n">bu_send</span><span class="o">.</span><span class="na">addActionListener</span><span class="o">(</span><span class="n">sendCaseMsgAction</span><span class="o">);</span>
        <span class="n">panel</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">jta_msg</span><span class="o">);</span>
        <span class="n">panel</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">bu_send</span><span class="o">);</span>

        <span class="c1">//使用服务器缓存中的TableMo</span>
        <span class="n">onlineUserTable</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JTable</span><span class="o">(</span><span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUserTableModel</span><span class="o">);</span>
        <span class="n">registedUserTable</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JTable</span><span class="o">(</span><span class="nc">DataBuffer</span><span class="o">.</span><span class="na">registedUserTableModel</span><span class="o">);</span>

        <span class="c1">//取得表格上的弹出菜单对象，加到表格上；</span>
        <span class="nc">JPopupMenu</span> <span class="n">pop</span> <span class="o">=</span> <span class="n">getTablePop</span><span class="o">();</span>
        <span class="n">onlineUserTable</span><span class="o">.</span><span class="na">setComponentPopupMenu</span><span class="o">(</span><span class="n">pop</span><span class="o">);</span>

        <span class="c1">//选项卡</span>
        <span class="nc">JTabbedPane</span> <span class="n">tabbedPane</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JTabbedPane</span><span class="o">();</span>
        <span class="n">tabbedPane</span><span class="o">.</span><span class="na">addTab</span><span class="o">(</span><span class="s">"在线用户列表"</span><span class="o">,</span><span class="k">new</span> <span class="nc">JScrollPane</span><span class="o">(</span><span class="n">onlineUserTable</span><span class="o">));</span>
        <span class="n">tabbedPane</span><span class="o">.</span><span class="na">addTab</span><span class="o">(</span><span class="s">"已注册用户列表"</span><span class="o">,</span><span class="k">new</span> <span class="nc">JScrollPane</span><span class="o">(</span><span class="n">registedUserTable</span><span class="o">));</span>
        <span class="n">tabbedPane</span><span class="o">.</span><span class="na">setTabComponentAt</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="k">new</span> <span class="nc">JLabel</span><span class="o">(</span><span class="s">"在线用户列表"</span><span class="o">));</span>
        <span class="k">this</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">tabbedPane</span><span class="o">,</span><span class="nc">BorderLayout</span><span class="o">.</span><span class="na">CENTER</span><span class="o">);</span>

        <span class="kd">final</span> <span class="nc">JLabel</span> <span class="n">stateBar</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JLabel</span><span class="o">(</span><span class="s">""</span><span class="o">,</span><span class="nc">SwingConstants</span><span class="o">.</span><span class="na">RIGHT</span><span class="o">);</span>
        <span class="n">stateBar</span><span class="o">.</span><span class="na">setBorder</span><span class="o">(</span><span class="nc">BorderFactory</span><span class="o">.</span><span class="na">createEtchedBorder</span><span class="o">(</span><span class="nc">EtchedBorder</span><span class="o">.</span><span class="na">LOWERED</span><span class="o">));</span>
        <span class="c1">//用定时任务来显示当前时间</span>
        <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Timer</span><span class="o">().</span><span class="na">scheduleAtFixedRate</span><span class="o">(</span>
                <span class="k">new</span> <span class="nf">TimerTask</span><span class="o">()</span> <span class="o">{</span>
                    <span class="nc">DateFormat</span> <span class="n">df</span> <span class="o">=</span><span class="k">new</span> <span class="nc">SimpleDateFormat</span><span class="o">(</span><span class="s">"yyyy年MM月dd日 HH:mm:ss"</span><span class="o">);</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                        <span class="n">stateBar</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">"当前时间："</span> <span class="o">+</span> <span class="n">df</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">())</span> <span class="o">+</span> <span class="s">"  "</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">},</span><span class="mi">0</span><span class="o">,</span><span class="mi">1000</span>
        <span class="o">);</span>
        <span class="c1">//把状态栏添加到窗体的南边</span>
        <span class="k">this</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">stateBar</span><span class="o">,</span><span class="nc">BorderLayout</span><span class="o">.</span><span class="na">SOUTH</span><span class="o">);</span>

        <span class="c1">//关闭窗口</span>
        <span class="k">this</span><span class="o">.</span><span class="na">addWindowListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">WindowAdapter</span><span class="o">(){</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">windowClosing</span><span class="o">(</span><span class="nc">WindowEvent</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">logout</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="cm">/* 添加关闭服务器按钮事件处理方法 */</span>
        <span class="n">exitBtn</span><span class="o">.</span><span class="na">addActionListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">ActionListener</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">actionPerformed</span><span class="o">(</span><span class="kd">final</span> <span class="nc">ActionEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">logout</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="c1">//创建表格上的弹出菜单对象 实现发信 踢人功能</span>
    <span class="kd">private</span> <span class="nc">JPopupMenu</span> <span class="nf">getTablePop</span><span class="o">(){</span>
        <span class="c1">//弹出菜单对象</span>
        <span class="nc">JPopupMenu</span> <span class="n">pop</span> <span class="o">=</span><span class="k">new</span> <span class="nc">JPopupMenu</span><span class="o">();</span>
        <span class="nc">JMenuItem</span> <span class="n">mi_send</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JMenuItem</span><span class="o">(</span><span class="s">"发信"</span><span class="o">);</span>
        <span class="c1">//菜单项对象</span>
        <span class="c1">//设定菜单命令关键字</span>
        <span class="n">mi_send</span><span class="o">.</span><span class="na">setActionCommand</span><span class="o">(</span><span class="s">"send"</span><span class="o">);</span>
        <span class="c1">//菜单项对象</span>
        <span class="nc">JMenuItem</span> <span class="n">mi_del</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JMenuItem</span><span class="o">(</span><span class="s">"踢掉"</span><span class="o">);</span>
        <span class="c1">//设定菜单命令关键字</span>
        <span class="n">mi_del</span><span class="o">.</span><span class="na">setActionCommand</span><span class="o">(</span><span class="s">"del"</span><span class="o">);</span>
        <span class="c1">//弹出菜单上的监视器对象</span>
        <span class="nc">ActionListener</span> <span class="n">al</span> <span class="o">=</span><span class="k">new</span> <span class="nc">ActionListener</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">actionPerformed</span><span class="o">(</span><span class="nc">ActionEvent</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// 哪个菜单项点击了 这个s就是其设定的ActionCommand</span>
                <span class="nc">String</span> <span class="n">s</span><span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">getActionCommand</span><span class="o">();</span>
                <span class="n">popMenuAction</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">};</span>
        <span class="n">mi_send</span><span class="o">.</span><span class="na">addActionListener</span><span class="o">(</span><span class="n">al</span><span class="o">);</span>
        <span class="n">mi_del</span><span class="o">.</span><span class="na">addActionListener</span><span class="o">(</span><span class="n">al</span><span class="o">);</span>
        <span class="n">pop</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">mi_send</span><span class="o">);</span>
        <span class="n">pop</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">mi_del</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">pop</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">// 处理弹出菜单上的事件</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">popMenuAction</span><span class="o">(</span><span class="nc">String</span> <span class="n">command</span><span class="o">){</span>
        <span class="c1">// 得到在表格上选中的行</span>
        <span class="kd">final</span> <span class="kt">int</span> <span class="n">selectIndex</span> <span class="o">=</span> <span class="n">onlineUserTable</span><span class="o">.</span><span class="na">getSelectedRow</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">usr_id</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">onlineUserTable</span><span class="o">.</span><span class="na">getValueAt</span><span class="o">(</span><span class="n">selectIndex</span><span class="o">,</span><span class="mi">0</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">usr_id</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">selectIndex</span><span class="o">==-</span><span class="mi">1</span><span class="o">){</span>
            <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">showMessageDialog</span><span class="o">(</span><span class="k">this</span><span class="o">,</span><span class="s">"请选择一个用户"</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">command</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"del"</span><span class="o">))</span> <span class="o">{</span>
            <span class="c1">// 从线程中移除处理线程对象</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">RequestProcessor</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUsersMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="nc">Long</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">usr_id</span><span class="o">)));</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">command</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"send"</span><span class="o">)){</span>
            <span class="kd">final</span> <span class="nc">JDialog</span> <span class="n">jd</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JDialog</span><span class="o">(</span><span class="k">this</span><span class="o">,</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">jd</span><span class="o">.</span><span class="na">setLayout</span><span class="o">(</span><span class="k">new</span> <span class="nc">FlowLayout</span><span class="o">());</span>
            <span class="n">jd</span><span class="o">.</span><span class="na">setSize</span><span class="o">(</span><span class="mi">200</span><span class="o">,</span><span class="mi">100</span><span class="o">);</span>
            <span class="kd">final</span> <span class="nc">JTextField</span> <span class="n">jtd_m</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JTextField</span><span class="o">(</span><span class="mi">20</span><span class="o">);</span>
            <span class="nc">JButton</span> <span class="n">jb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JButton</span><span class="o">(</span><span class="s">"发送"</span><span class="o">);</span>
            <span class="n">jd</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">jtd_m</span><span class="o">);</span>
            <span class="n">jd</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">jb</span><span class="o">);</span>
            <span class="c1">//发送按钮的事件实现</span>
            <span class="n">jb</span><span class="o">.</span><span class="na">addActionListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">ActionListener</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">actionPerformed</span><span class="o">(</span><span class="nc">ActionEvent</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"服务器发送了一条消息"</span><span class="o">);</span>
                    <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">jtd_m</span><span class="o">.</span><span class="na">getText</span><span class="o">();</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="nc">RequestProcessor</span><span class="o">.</span><span class="na">chat_sys</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span><span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUsersMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="nc">Long</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">usr_id</span><span class="o">)));</span>
                    <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e1</span><span class="o">){</span>
                        <span class="n">e1</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                    <span class="o">}</span>
                    <span class="c1">//清空输入框</span>
                    <span class="n">jtd_m</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
                    <span class="n">jd</span><span class="o">.</span><span class="na">dispose</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="n">jd</span><span class="o">.</span><span class="na">setVisible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
            <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">showMessageDialog</span><span class="o">(</span><span class="k">this</span><span class="o">,</span><span class="s">"未知菜单"</span><span class="o">+</span><span class="n">command</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">//刷新表格</span>
        <span class="nc">SwingUtilities</span><span class="o">.</span><span class="na">updateComponentTreeUI</span><span class="o">(</span><span class="n">onlineUserTable</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//按下发送服务器消息的按钮，给所有在线用户发送消息</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">sendAllMsg</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">{</span>
        <span class="nc">RequestProcessor</span><span class="o">.</span><span class="na">board</span><span class="o">(</span><span class="n">jta_msg</span><span class="o">.</span><span class="na">getText</span><span class="o">());</span>
        <span class="c1">//清空输入框</span>
        <span class="n">jta_msg</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//把所有已注册的用户信息加载到RegistedUserTableModel中</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">loadData</span><span class="o">(){</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">users</span><span class="o">=</span><span class="k">new</span> <span class="nc">UserService</span><span class="o">().</span><span class="na">loadAllUser</span><span class="o">();</span>
        <span class="k">for</span><span class="o">(</span><span class="nc">User</span> <span class="nl">user:</span><span class="n">users</span><span class="o">){</span>
            <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">registedUserTableModel</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">[]{</span>
                <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">()),</span>
                <span class="n">user</span><span class="o">.</span><span class="na">getPassword</span><span class="o">(),</span>
                <span class="n">user</span><span class="o">.</span><span class="na">getNickname</span><span class="o">(),</span>
                <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getSex</span><span class="o">())</span>
            <span class="o">});</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="c1">//关闭服务器</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">logout</span><span class="o">(){</span>
        <span class="c1">//弹出提示窗口</span>
        <span class="kt">int</span> <span class="n">select</span> <span class="o">=</span> <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">showConfirmDialog</span><span class="o">(</span><span class="nc">ServerInfoFrame</span><span class="o">.</span><span class="na">this</span><span class="o">,</span>
                <span class="s">"确定关闭吗？\n\n关闭服务器将中断与所有客户端的连接!"</span><span class="o">,</span>
                <span class="s">"关闭服务器"</span><span class="o">,</span>
                <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">YES_NO_OPTION</span><span class="o">);</span>
        <span class="c1">//如果用户点击的是关闭服务器按钮时会提示是否确认关闭。</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">select</span> <span class="o">==</span> <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">YES_OPTION</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span><span class="c1">//退出系统</span>
        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
            <span class="c1">//覆盖默认的窗口关闭事件动作</span>
            <span class="n">setDefaultCloseOperation</span><span class="o">(</span><span class="nc">JFrame</span><span class="o">.</span><span class="na">DO_NOTHING_ON_CLOSE</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>entity 中的两个类仅用于界面，所以不会进行介绍。</p><h1 id="运行结果">运行结果</h1><p><img data-src="/assets/blog_res/2022-06-16-Service.assets/image-20220617152915327.png" alt="image-20220617152915327" data-proofer-ignore></p><p><img data-src="/assets/blog_res/2022-06-16-Service.assets/image-20220617152931194.png" alt="image-20220617152931194" data-proofer-ignore></p><p><img data-src="/assets/blog_res/2022-06-16-Service.assets/image-20220617152956174.png" alt="image-20220617152956174" data-proofer-ignore></p><p><img data-src="/assets/blog_res/2022-06-16-Service.assets/image-20220617153019493.png" alt="image-20220617153019493" data-proofer-ignore></p><p><img data-src="/assets/blog_res/2022-06-16-Service.assets/image-20220617153037535.png" alt="image-20220617153037535" data-proofer-ignore></p><p>基本完成，看起来还不错，就是有点丑。</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%E8%AF%BE%E8%AE%BE/'>课设</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/java/" class="post-tag no-text-decoration" >Java</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=JAVA-Socket%E9%80%9A%E4%BF%A1+%E8%81%8A%E5%A4%A9%E5%AE%A4%EF%BC%88%E6%9C%8D%E5%8A%A1%E7%AB%AF%EF%BC%89+-+Aye486&url=%2Fposts%2FService%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=JAVA-Socket%E9%80%9A%E4%BF%A1+%E8%81%8A%E5%A4%A9%E5%AE%A4%EF%BC%88%E6%9C%8D%E5%8A%A1%E7%AB%AF%EF%BC%89+-+Aye486&u=%2Fposts%2FService%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2FService%2F&text=JAVA-Socket%E9%80%9A%E4%BF%A1+%E8%81%8A%E5%A4%A9%E5%AE%A4%EF%BC%88%E6%9C%8D%E5%8A%A1%E7%AB%AF%EF%BC%89+-+Aye486" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" data-title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/plane-war/">飞机大战</a><li><a href="/posts/hello-world/">你好，世界！</a><li><a href="/posts/%E5%8D%8F%E7%A8%8B%E5%92%8Clibco/">协程简介</a><li><a href="/posts/client/">JAVA-Socket通信 聊天室（客户端）</a><li><a href="/posts/Service/">JAVA-Socket通信 聊天室（服务端）</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/%E7%AE%97%E6%B3%95/">算法</a> <a class="post-tag" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a> <a class="post-tag" href="/tags/game/">Game</a> <a class="post-tag" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/">计算机基础</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/common/"><div class="card-body"> <em class="small" data-ts="1655298120" data-df="YYYY-MM-DD" > 2022-06-15 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>JAVA-Socket通信 聊天室（工具类）</h3><div class="text-muted small"><p> 关于聊天室中工具类部分 整体思路 把要传输的内容封装成了两个类 Response 和 Request，客户端向服务器发起请求，服务器向客户端回应，通过两个类中包含的请求类型来判断需要进行的操作，传输采用ObjectStream。仔细以看其实会发现，这两个类内容很相似。 Request public class Request implements Serializable { ...</p></div></div></a></div><div class="card"> <a href="/posts/chartroom/"><div class="card-body"> <em class="small" data-ts="1655298120" data-df="YYYY-MM-DD" > 2022-06-15 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>JAVA-Socket通信 聊天室</h3><div class="text-muted small"><p> 聊天室曾经盛行一时，今天我们就用简单的java代码来复刻他。 一、项目名称 聊天室 二、功能介绍 用Java图形用户界面编写聊天室服务器端和客户端， 支持多个客户端连接到一个服务器。每个客户端能够输入账号，包括注册功能。 可以实现群聊（聊天记录显示在所有客户端界面）。 完成好友列表在各个客户端上显示，包括头像和用户名。 ...</p></div></div></a></div><div class="card"> <a href="/posts/client/"><div class="card-body"> <em class="small" data-ts="1655298120" data-df="YYYY-MM-DD" > 2022-06-15 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>JAVA-Socket通信 聊天室（客户端）</h3><div class="text-muted small"><p> 关于聊天室中客户端部分 整体思路 客户端的代码用到的类如上所示，其中 entity 中的两个类仅用于界面，所以不会进行介绍。 Thread 客户端线程，一个线程表示一个用户，处理服务器发来的消息，在里面用了 currentFrame 这个变量来表示当前窗口。 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/chartroom/" class="btn btn-outline-primary" prompt="上一篇"><p>JAVA-Socket通信 聊天室</p></a> <a href="/posts/client/" class="btn btn-outline-primary" prompt="下一篇"><p>JAVA-Socket通信 聊天室（客户端）</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/Aye486">Aye486</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/%E7%AE%97%E6%B3%95/">算法</a> <a class="post-tag" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a> <a class="post-tag" href="/tags/game/">Game</a> <a class="post-tag" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/">计算机基础</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3"></p><button type="button" class="btn btn-primary" aria-label="Update"> </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/asia/jinan.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
