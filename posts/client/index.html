<!DOCTYPE html><html lang="zh-CN" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="prefer-datetime-locale" content="Asia/Jinan"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="JAVA-Socket通信 聊天室（客户端）" /><meta name="author" content="Aye486" /><meta property="og:locale" content="zh_CN" /><meta name="description" content="关于聊天室中客户端部分" /><meta property="og:description" content="关于聊天室中客户端部分" /><link rel="canonical" href="/posts/client/" /><meta property="og:url" content="/posts/client/" /><meta property="og:site_name" content="Aye486" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-06-15T13:02:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="JAVA-Socket通信 聊天室（客户端）" /><meta name="twitter:site" content="@Aye486" /><meta name="twitter:creator" content="@Aye486" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Aye486"},"dateModified":"2022-06-25T14:19:58+00:00","datePublished":"2022-06-15T13:02:00+00:00","description":"关于聊天室中客户端部分","headline":"JAVA-Socket通信 聊天室（客户端）","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/client/"},"url":"/posts/client/"}</script><title>JAVA-Socket通信 聊天室（客户端） | Aye486</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Aye486"><meta name="application-name" content="Aye486"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/config/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Aye486</a></div><div class="site-subtitle font-italic">这里是Aye486的博客～</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>首页</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>分类</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>标签</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>归档</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>关于</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/Aye486" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/Aye486" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['cwy1143','163.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> 首页 </a> </span> <span>JAVA-Socket通信 聊天室（客户端）</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> 文章</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="搜索..."> </span> <span id="search-cancel" >取消</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>JAVA-Socket通信 聊天室（客户端）</h1><div class="post-meta text-muted"> <span> 发表于 <em class="" data-ts="1655298120" data-df="YYYY-MM-DD" data-toggle="tooltip" data-placement="bottom"> 2022-06-15 </em> </span> <span> 更新于 <em class="" data-ts="1656166798" data-df="YYYY-MM-DD" data-toggle="tooltip" data-placement="bottom"> 2022-06-25 </em> </span><div class="d-flex justify-content-between"> <span> 作者 <em> Aye486 </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="5409 字"> <em>30 分钟</em>阅读</span></div></div></div><div class="post-content"><h1 id="关于聊天室中客户端部分">关于聊天室中客户端部分</h1><h2 id="整体思路"><span class="mr-2">整体思路</span><a href="#整体思路" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><img data-src="/assets/blog_res/2022-06-16-client.assets/image-20220617111831298.png" alt="image-20220617111831298" data-proofer-ignore></p><p>客户端的代码用到的类如上所示，其中 entity 中的两个类仅用于界面，所以不会进行介绍。</p><h3 id="thread"><span class="mr-2">Thread</span><a href="#thread" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>客户端线程，一个线程表示一个用户，处理服务器发来的消息，在里面用了 currentFrame 这个变量来表示当前窗口。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
</pre><td class="rouge-code"><pre><span class="c1">//客户端线程  监听服务器发送过来的信息</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Thread</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>
    <span class="c1">//当前窗体</span>
    <span class="kd">private</span> <span class="nc">JFrame</span> <span class="n">currentFrame</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ClientThread</span><span class="o">(</span><span class="nc">JFrame</span> <span class="n">frame</span><span class="o">){</span>
        <span class="n">currentFrame</span> <span class="o">=</span> <span class="n">frame</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">//客户端与服务器处于连接状态</span>
            <span class="k">while</span> <span class="o">(</span><span class="nc">DataBuffer</span><span class="o">.</span><span class="na">clientSeocket</span><span class="o">.</span><span class="na">isConnected</span><span class="o">())</span> <span class="o">{</span>
                <span class="c1">//从客户端得输入流读取服务器响应信息</span>
                <span class="nc">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Response</span><span class="o">)</span> <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
                <span class="nc">ResponseType</span> <span class="n">type</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="na">getType</span><span class="o">();</span>

                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"获取了响应内容："</span> <span class="o">+</span> <span class="n">type</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="nc">ResponseType</span><span class="o">.</span><span class="na">LOGIN</span><span class="o">)</span> <span class="o">{</span><span class="c1">//用户登录</span>
                    <span class="nc">User</span> <span class="n">newUser</span> <span class="o">=</span> <span class="o">(</span><span class="nc">User</span><span class="o">)</span><span class="n">response</span><span class="o">.</span><span class="na">getData</span><span class="o">(</span><span class="s">"loginUser"</span><span class="o">);</span>  <span class="c1">//添加到在线用户列表</span>
                    <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUserListModel</span><span class="o">.</span><span class="na">addElement</span><span class="o">(</span><span class="n">newUser</span><span class="o">);</span>
                    <span class="c1">//在服务器端重新打印在线用户信息</span>
                    <span class="nc">ChatFrame</span><span class="o">.</span><span class="na">onlineCountLbl</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span>
                            <span class="s">"在线用户列表("</span><span class="o">+</span> <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUserListModel</span><span class="o">.</span><span class="na">getSize</span><span class="o">()</span> <span class="o">+</span><span class="s">")"</span><span class="o">);</span>
                    <span class="nc">ClientUtil</span><span class="o">.</span><span class="na">appendTxt2MsgListArea</span><span class="o">(</span><span class="s">"【系统消息】用户"</span><span class="o">+</span><span class="n">newUser</span><span class="o">.</span><span class="na">getNickname</span><span class="o">()</span> <span class="o">+</span> <span class="s">"上线了！\n"</span><span class="o">);</span> <span class="c1">//在客户端页面提示用户上线信息</span>
                <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="nc">ResponseType</span><span class="o">.</span><span class="na">LOGOUT</span><span class="o">){</span> <span class="c1">//用户退出</span>
                    <span class="nc">User</span> <span class="n">newUser</span> <span class="o">=</span> <span class="o">(</span><span class="nc">User</span><span class="o">)</span><span class="n">response</span><span class="o">.</span><span class="na">getData</span><span class="o">(</span><span class="s">"logoutUser"</span><span class="o">);</span> <span class="c1">//从在线用户列表删除</span>
                    <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUserListModel</span><span class="o">.</span><span class="na">removeElement</span><span class="o">(</span><span class="n">newUser</span><span class="o">);</span>
                    <span class="c1">//在服务器端重新打印在线用户信息</span>
                    <span class="nc">ChatFrame</span><span class="o">.</span><span class="na">onlineCountLbl</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span>
                            <span class="s">"在线用户列表("</span><span class="o">+</span> <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUserListModel</span><span class="o">.</span><span class="na">getSize</span><span class="o">()</span> <span class="o">+</span><span class="s">")"</span><span class="o">);</span>
                    <span class="nc">ClientUtil</span><span class="o">.</span><span class="na">appendTxt2MsgListArea</span><span class="o">(</span><span class="s">"【系统消息】用户"</span><span class="o">+</span><span class="n">newUser</span><span class="o">.</span><span class="na">getNickname</span><span class="o">()</span> <span class="o">+</span> <span class="s">"下线了！\n"</span><span class="o">);</span> <span class="c1">//在客户端聊天界面提示用户下线</span>

                <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="nc">ResponseType</span><span class="o">.</span><span class="na">CHAT</span><span class="o">){</span> <span class="c1">//聊天</span>
                    <span class="nc">Message</span> <span class="n">msg</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Message</span><span class="o">)</span><span class="n">response</span><span class="o">.</span><span class="na">getData</span><span class="o">(</span><span class="s">"txtMsg"</span><span class="o">);</span>
                    <span class="nc">ClientUtil</span><span class="o">.</span><span class="na">appendTxt2MsgListArea</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
                <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="nc">ResponseType</span><span class="o">.</span><span class="na">TOSENDFILE</span><span class="o">){</span> <span class="c1">//准备发送文件</span>
                    <span class="n">toSendFile</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
                <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="nc">ResponseType</span><span class="o">.</span><span class="na">AGREERECEIVEFILE</span><span class="o">){</span> <span class="c1">//对方同意接收文件</span>
                    <span class="n">sendFile</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
                <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="nc">ResponseType</span><span class="o">.</span><span class="na">REFUSERECEIVEFILE</span><span class="o">){</span> <span class="c1">//对方拒绝接收文件</span>
                    <span class="nc">ClientUtil</span><span class="o">.</span><span class="na">appendTxt2MsgListArea</span><span class="o">(</span><span class="s">"【文件消息】对方拒绝接收，文件发送失败！\n"</span><span class="o">);</span>
                <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="nc">ResponseType</span><span class="o">.</span><span class="na">RECEIVEFILE</span><span class="o">){</span> <span class="c1">//开始接收文件</span>
                    <span class="n">receiveFile</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
                <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="nc">ResponseType</span><span class="o">.</span><span class="na">BOARD</span><span class="o">){</span>  <span class="c1">//服务器发送广播消息</span>
                    <span class="nc">Message</span> <span class="n">msg</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Message</span><span class="o">)</span><span class="n">response</span><span class="o">.</span><span class="na">getData</span><span class="o">(</span><span class="s">"txtMsg"</span><span class="o">);</span>
                    <span class="nc">ClientUtil</span><span class="o">.</span><span class="na">appendTxt2MsgListArea</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
                <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="nc">ResponseType</span><span class="o">.</span><span class="na">REMOVE</span><span class="o">){</span> <span class="c1">//服务器剔除用户</span>
                    <span class="nc">ChatFrame</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//e.printStackTrace();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">//发送文件</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">sendFile</span><span class="o">(</span><span class="nc">Response</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//创建待发送文件对象</span>
        <span class="kd">final</span> <span class="nc">FileInfo</span> <span class="n">sendFile</span> <span class="o">=</span> <span class="o">(</span><span class="nc">FileInfo</span><span class="o">)</span><span class="n">response</span><span class="o">.</span><span class="na">getData</span><span class="o">(</span><span class="s">"sendFile"</span><span class="o">);</span>
        <span class="c1">//输入输出缓冲字节流</span>
        <span class="nc">BufferedInputStream</span> <span class="n">bis</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">BufferedOutputStream</span> <span class="n">bos</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">//套接字连接</span>
            <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Socket</span><span class="o">(</span><span class="n">sendFile</span><span class="o">.</span><span class="na">getDestIp</span><span class="o">(),</span><span class="n">sendFile</span><span class="o">.</span><span class="na">getDestPort</span><span class="o">());</span>
            <span class="c1">//文件读入</span>
            <span class="n">bis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedInputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="n">sendFile</span><span class="o">.</span><span class="na">getSrcName</span><span class="o">()));</span>
            <span class="c1">//文件写出</span>
            <span class="n">bos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedOutputStream</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">());</span>
            <span class="c1">//写入缓冲区</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">1024</span><span class="o">];</span>
            <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">((</span><span class="n">n</span> <span class="o">=</span> <span class="n">bis</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">){</span>
                <span class="n">bos</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">n</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">bos</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//提示消息</span>
                <span class="nc">ClientUtil</span><span class="o">.</span><span class="na">appendTxt2MsgListArea</span><span class="o">(</span><span class="s">"【文件消息】文件发送完毕!\n"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span><span class="k">finally</span><span class="o">{</span>
            <span class="nc">IOUtil</span><span class="o">.</span><span class="na">close</span><span class="o">(</span><span class="n">bis</span><span class="o">,</span><span class="n">bos</span><span class="o">);</span>
            <span class="nc">SocketUtil</span><span class="o">.</span><span class="na">close</span><span class="o">(</span><span class="n">socket</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">//接收文件</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">receiveFile</span><span class="o">(</span><span class="nc">Response</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//创建待发送文件对象</span>
        <span class="kd">final</span> <span class="nc">FileInfo</span> <span class="n">sendFile</span> <span class="o">=</span> <span class="o">(</span><span class="nc">FileInfo</span><span class="o">)</span><span class="n">response</span><span class="o">.</span><span class="na">getData</span><span class="o">(</span><span class="s">"sendFile"</span><span class="o">);</span>
        <span class="c1">//输入输出缓冲字节流</span>
        <span class="nc">BufferedInputStream</span> <span class="n">bis</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">BufferedOutputStream</span> <span class="n">bos</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">ServerSocket</span> <span class="n">serverSocket</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">serverSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerSocket</span><span class="o">(</span><span class="n">sendFile</span><span class="o">.</span><span class="na">getDestPort</span><span class="o">());</span>
            <span class="c1">//接收</span>
            <span class="n">socket</span> <span class="o">=</span> <span class="n">serverSocket</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
            <span class="c1">//缓冲读</span>
            <span class="n">bis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedInputStream</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>
            <span class="c1">//缓冲写出</span>
            <span class="n">bos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="n">sendFile</span><span class="o">.</span><span class="na">getDestName</span><span class="o">()));</span>

            <span class="kt">byte</span><span class="o">[]</span> <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">1024</span><span class="o">];</span>
            <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">((</span><span class="n">n</span> <span class="o">=</span> <span class="n">bis</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">){</span>
                <span class="n">bos</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">n</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">bos</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//提示信息</span>
                <span class="nc">ClientUtil</span><span class="o">.</span><span class="na">appendTxt2MsgListArea</span><span class="o">(</span><span class="s">"【文件消息】文件接收完毕!存放在["</span>
                        <span class="o">+</span> <span class="n">sendFile</span><span class="o">.</span><span class="na">getDestName</span><span class="o">()+</span><span class="s">"]\n"</span><span class="o">);</span>
            <span class="o">}</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span><span class="k">finally</span><span class="o">{</span>
            <span class="nc">IOUtil</span><span class="o">.</span><span class="na">close</span><span class="o">(</span><span class="n">bis</span><span class="o">,</span><span class="n">bos</span><span class="o">);</span>
            <span class="nc">SocketUtil</span><span class="o">.</span><span class="na">close</span><span class="o">(</span><span class="n">socket</span><span class="o">);</span>
            <span class="nc">SocketUtil</span><span class="o">.</span><span class="na">close</span><span class="o">(</span><span class="n">serverSocket</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// 准备发送文件</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">toSendFile</span><span class="o">(</span><span class="nc">Response</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">FileInfo</span> <span class="n">sendFile</span> <span class="o">=</span> <span class="o">(</span><span class="nc">FileInfo</span><span class="o">)</span><span class="n">response</span><span class="o">.</span><span class="na">getData</span><span class="o">(</span><span class="s">"sendFile"</span><span class="o">);</span>
        <span class="c1">//获取发送者昵称</span>
        <span class="nc">String</span> <span class="n">fromName</span> <span class="o">=</span> <span class="n">sendFile</span><span class="o">.</span><span class="na">getFromUser</span><span class="o">().</span><span class="na">getNickname</span><span class="o">()</span>
                <span class="o">+</span> <span class="s">"("</span> <span class="o">+</span> <span class="n">sendFile</span><span class="o">.</span><span class="na">getFromUser</span><span class="o">().</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">")"</span><span class="o">;</span>
        <span class="c1">//获取文件名称</span>
        <span class="nc">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">sendFile</span><span class="o">.</span><span class="na">getSrcName</span><span class="o">()</span>
                <span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">sendFile</span><span class="o">.</span><span class="na">getSrcName</span><span class="o">().</span><span class="na">lastIndexOf</span><span class="o">(</span><span class="nc">File</span><span class="o">.</span><span class="na">separator</span><span class="o">)+</span><span class="mi">1</span><span class="o">);</span>
        <span class="c1">//弹出提示窗口  获得用户的选择</span>
        <span class="kt">int</span> <span class="n">select</span> <span class="o">=</span> <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">showConfirmDialog</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">currentFrame</span><span class="o">,</span>
                <span class="n">fromName</span> <span class="o">+</span> <span class="s">" 向您发送文件 ["</span> <span class="o">+</span> <span class="n">fileName</span><span class="o">+</span> <span class="s">"]!\n同意接收吗?"</span><span class="o">,</span>
                <span class="s">"接收文件"</span><span class="o">,</span> <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">YES_NO_OPTION</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Request</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Request</span><span class="o">();</span>
            <span class="n">request</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"sendFile"</span><span class="o">,</span> <span class="n">sendFile</span><span class="o">);</span>
            <span class="c1">//用户同意接受文件</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">select</span> <span class="o">==</span> <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">YES_OPTION</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//选择接收文件的存放地址</span>
                <span class="nc">JFileChooser</span> <span class="n">jfc</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JFileChooser</span><span class="o">();</span>
                <span class="n">jfc</span><span class="o">.</span><span class="na">setSelectedFile</span><span class="o">(</span><span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">fileName</span><span class="o">));</span>
                <span class="c1">//地址选择结果</span>
                <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">jfc</span><span class="o">.</span><span class="na">showSaveDialog</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">currentFrame</span><span class="o">);</span>
                <span class="c1">//地址没有问题</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="nc">JFileChooser</span><span class="o">.</span><span class="na">APPROVE_OPTION</span><span class="o">){</span>
                    <span class="c1">//设置目的地文件名</span>
                    <span class="n">sendFile</span><span class="o">.</span><span class="na">setDestName</span><span class="o">(</span><span class="n">jfc</span><span class="o">.</span><span class="na">getSelectedFile</span><span class="o">().</span><span class="na">getCanonicalPath</span><span class="o">());</span>
                    <span class="c1">//设置目标地的IP和接收文件的端口</span>
                    <span class="n">sendFile</span><span class="o">.</span><span class="na">setDestIp</span><span class="o">(</span><span class="nc">DataBuffer</span><span class="o">.</span><span class="na">ip</span><span class="o">);</span>
                    <span class="n">sendFile</span><span class="o">.</span><span class="na">setDestPort</span><span class="o">(</span><span class="nc">DataBuffer</span><span class="o">.</span><span class="na">RECEIVE_FILE_PORT</span><span class="o">);</span>

                    <span class="n">request</span><span class="o">.</span><span class="na">setAction</span><span class="o">(</span><span class="s">"agreeReceiveFile"</span><span class="o">);</span>
                    <span class="nc">ClientUtil</span><span class="o">.</span><span class="na">appendTxt2MsgListArea</span><span class="o">(</span><span class="s">"【文件消息】您已同意接收来自 "</span>
                            <span class="o">+</span> <span class="n">fromName</span> <span class="o">+</span><span class="s">" 的文件，正在接收文件 ...\n"</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span><span class="c1">//地址选择有误或未选择地址</span>
                    <span class="n">request</span><span class="o">.</span><span class="na">setAction</span><span class="o">(</span><span class="s">"refuseReceiveFile"</span><span class="o">);</span>
                    <span class="nc">ClientUtil</span><span class="o">.</span><span class="na">appendTxt2MsgListArea</span><span class="o">(</span><span class="s">"【文件消息】您已拒绝接收来自 "</span>
                            <span class="o">+</span> <span class="n">fromName</span> <span class="o">+</span><span class="s">" 的文件!\n"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span><span class="c1">//拒绝接受文件</span>
                <span class="n">request</span><span class="o">.</span><span class="na">setAction</span><span class="o">(</span><span class="s">"refuseReceiveFile"</span><span class="o">);</span>
                <span class="nc">ClientUtil</span><span class="o">.</span><span class="na">appendTxt2MsgListArea</span><span class="o">(</span><span class="s">"【文件消息】您已拒绝接收来自 "</span>
                        <span class="o">+</span> <span class="n">fromName</span> <span class="o">+</span><span class="s">" 的文件!\n"</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="nc">ClientUtil</span><span class="o">.</span><span class="na">sendTextRequest2</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="clientutil"><span class="mr-2">ClientUtil</span><a href="#clientutil" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>用于客户端向服务器发送消息。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="c1">//客户端发送请求到服务器的工具</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ClientUtil</span> <span class="o">{</span>
    <span class="c1">//发送请求对象,主动接收响应</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Response</span> <span class="nf">sendTextRequest</span><span class="o">(</span><span class="nc">Request</span> <span class="n">request</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">//发送请求</span>
            <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
            <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">oos</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"客户端发送了请求对象:"</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="na">getAction</span><span class="o">());</span>

            <span class="k">if</span> <span class="o">(!</span><span class="s">"exit"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getAction</span><span class="o">()))</span> <span class="o">{</span>
                <span class="c1">// 获取响应</span>
                <span class="n">response</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Response</span><span class="o">)</span> <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">ois</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"客户端获取到了响应对象:"</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="na">getStatus</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"客户端断开连接"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ClassNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">//发送请求对象,不主动接收响应</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">sendTextRequest2</span><span class="o">(</span><span class="nc">Request</span> <span class="n">request</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">request</span><span class="o">);</span> <span class="c1">// 发送请求</span>
            <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">oos</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"客户端发送了请求对象:"</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="na">getAction</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">//把指定文本添加到消息列表文本域中</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">appendTxt2MsgListArea</span><span class="o">(</span><span class="nc">String</span> <span class="n">txt</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ChatFrame</span><span class="o">.</span><span class="na">msgListArea</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">txt</span><span class="o">);</span>
        <span class="c1">//把光标定位到文本域的最后一行</span>
        <span class="nc">ChatFrame</span><span class="o">.</span><span class="na">msgListArea</span><span class="o">.</span><span class="na">setCaretPosition</span><span class="o">(</span><span class="nc">ChatFrame</span><span class="o">.</span><span class="na">msgListArea</span><span class="o">.</span><span class="na">getDocument</span><span class="o">().</span><span class="na">getLength</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="databuffer"><span class="mr-2">DataBuffer</span><a href="#databuffer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>用于客户端从文件中读取数据，进行缓存。</p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DataBuffer</span> <span class="o">{</span>
    <span class="c1">//当前客户端的用户信息</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">User</span> <span class="n">currentUser</span><span class="o">;</span>
    <span class="c1">//在线用户列表</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">onlineUsers</span><span class="o">;</span>
    <span class="c1">//当前客户端连接到服务器的socket</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Socket</span> <span class="n">clientSeocket</span><span class="o">;</span>
    <span class="c1">//当前客户端连接到服务器的输出流</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">ObjectOutputStream</span> <span class="n">oos</span><span class="o">;</span>
    <span class="c1">//当前客户端连接到服务器的输入流</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">ObjectInputStream</span> <span class="n">ois</span><span class="o">;</span>
    <span class="c1">//服务器配置参数属性集</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Properties</span> <span class="n">configProp</span><span class="o">;</span>
    <span class="c1">// 当前客户端的屏幕尺寸</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Dimension</span> <span class="n">screenSize</span><span class="o">;</span>
    <span class="c1">//本客户端的IP地址</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="n">ip</span> <span class="o">;</span>
    <span class="c1">//用来接收文件的端口</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">RECEIVE_FILE_PORT</span> <span class="o">=</span> <span class="mi">6667</span><span class="o">;</span>
    <span class="c1">// 在线用户JList的Model</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">OnlineUserListModel</span> <span class="n">onlineUserListModel</span><span class="o">;</span>

    <span class="kd">static</span><span class="o">{</span>
        <span class="n">screenSize</span> <span class="o">=</span> <span class="nc">Toolkit</span><span class="o">.</span><span class="na">getDefaultToolkit</span><span class="o">().</span><span class="na">getScreenSize</span><span class="o">();</span>
        <span class="c1">//加载服务器配置文件</span>
        <span class="n">configProp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Properties</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">//获取本地IP地址</span>
            <span class="n">ip</span> <span class="o">=</span> <span class="nc">InetAddress</span><span class="o">.</span><span class="na">getLocalHost</span><span class="o">().</span><span class="na">getHostAddress</span><span class="o">();</span>
            <span class="c1">//从输入流中读取属性列表（键和元素对）</span>
            <span class="n">configProp</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">getContextClassLoader</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">"serverconfig.properties"</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nf">DataBuffer</span><span class="o">(){}</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="chatgui"><span class="mr-2">ChatGUI</span><a href="#chatgui" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>聊天界面大致形状</p><p><img data-src="/assets/blog_res/2022-06-16-client.assets/2.png" alt="2" data-proofer-ignore></p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChatGUI</span> <span class="kd">extends</span> <span class="nc">JFrame</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3426717670093483287L</span><span class="o">;</span>
    <span class="c1">//聊天对方的信息Label</span>
    <span class="kd">private</span> <span class="nc">JLabel</span> <span class="n">otherInfoLbl</span><span class="o">;</span>
    <span class="c1">//当前用户信息Lbl</span>
    <span class="kd">private</span> <span class="nc">JLabel</span> <span class="n">currentUserLbl</span><span class="o">;</span>
    <span class="c1">//聊天信息列表区域</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">JTextArea</span> <span class="n">msgListArea</span><span class="o">;</span>
    <span class="c1">//要发送的信息区域</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">JTextArea</span> <span class="n">sendArea</span><span class="o">;</span>
    <span class="c1">//在线用户列表</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">JList</span> <span class="n">onlineList</span><span class="o">;</span>
    <span class="c1">// 在线用户数统计Lbl</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">JLabel</span> <span class="n">onlineCountLbl</span><span class="o">;</span>
    <span class="c1">//准备发送文件</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">FileInfo</span> <span class="n">sendFile</span><span class="o">;</span>
    <span class="c1">//私聊复选框</span>
    <span class="kd">public</span> <span class="nc">JCheckBox</span> <span class="n">rybqBtn</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">ChatFrame</span><span class="o">(){</span>
        <span class="k">this</span><span class="o">.</span><span class="na">init</span><span class="o">();</span>
        <span class="c1">//调用任意已注册 WindowListener 的对象后自动隐藏并释放该窗体。</span>
        <span class="k">this</span><span class="o">.</span><span class="na">setDefaultCloseOperation</span><span class="o">(</span><span class="no">DISPOSE_ON_CLOSE</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">setVisible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//初始化</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(){</span>
        <span class="k">this</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="s">"MY CHART ROOM"</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">setSize</span><span class="o">(</span><span class="mi">550</span><span class="o">,</span> <span class="mi">500</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">setResizable</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

        <span class="c1">//设置默认窗体在屏幕中央</span>
        <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="nc">Toolkit</span><span class="o">.</span><span class="na">getDefaultToolkit</span><span class="o">().</span><span class="na">getScreenSize</span><span class="o">().</span><span class="na">getWidth</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="nc">Toolkit</span><span class="o">.</span><span class="na">getDefaultToolkit</span><span class="o">().</span><span class="na">getScreenSize</span><span class="o">().</span><span class="na">getHeight</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">setLocation</span><span class="o">((</span><span class="n">x</span> <span class="o">-</span> <span class="k">this</span><span class="o">.</span><span class="na">getWidth</span><span class="o">())</span> <span class="o">/</span> <span class="mi">2</span><span class="o">,</span> <span class="o">(</span><span class="n">y</span><span class="o">-</span><span class="k">this</span><span class="o">.</span><span class="na">getHeight</span><span class="o">())/</span> <span class="mi">2</span><span class="o">);</span>

        <span class="c1">//左边用户面板</span>
        <span class="nc">JPanel</span> <span class="n">userPanel</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JPanel</span><span class="o">();</span>
        <span class="n">userPanel</span><span class="o">.</span><span class="na">setLayout</span><span class="o">(</span><span class="k">new</span> <span class="nc">BorderLayout</span><span class="o">());</span>
        <span class="c1">//右边主面板</span>
        <span class="nc">JPanel</span> <span class="n">mainPanel</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JPanel</span><span class="o">();</span>
        <span class="n">mainPanel</span><span class="o">.</span><span class="na">setLayout</span><span class="o">(</span><span class="k">new</span> <span class="nc">BorderLayout</span><span class="o">());</span>


        <span class="c1">// 创建一个分隔窗格</span>
        <span class="nc">JSplitPane</span> <span class="n">splitPane</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JSplitPane</span><span class="o">(</span><span class="nc">JSplitPane</span><span class="o">.</span><span class="na">HORIZONTAL_SPLIT</span><span class="o">,</span>
                <span class="n">userPanel</span><span class="o">,</span> <span class="n">mainPanel</span><span class="o">);</span>
        <span class="n">splitPane</span><span class="o">.</span><span class="na">setDividerLocation</span><span class="o">(</span><span class="mi">125</span><span class="o">);</span>
        <span class="n">splitPane</span><span class="o">.</span><span class="na">setDividerSize</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
        <span class="n">splitPane</span><span class="o">.</span><span class="na">setOneTouchExpandable</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">splitPane</span><span class="o">,</span> <span class="nc">BorderLayout</span><span class="o">.</span><span class="na">CENTER</span><span class="o">);</span>


        <span class="c1">//在线用户列表展示</span>
        <span class="nc">JPanel</span> <span class="n">onlineListPane</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JPanel</span><span class="o">();</span>
        <span class="n">onlineListPane</span><span class="o">.</span><span class="na">setLayout</span><span class="o">(</span><span class="k">new</span> <span class="nc">BorderLayout</span><span class="o">());</span>
        <span class="n">onlineCountLbl</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JLabel</span><span class="o">(</span><span class="s">"在线用户"</span><span class="o">);</span>
        <span class="n">onlineListPane</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">onlineCountLbl</span><span class="o">,</span> <span class="nc">BorderLayout</span><span class="o">.</span><span class="na">NORTH</span><span class="o">);</span>

        <span class="c1">//当前用户面板</span>
        <span class="nc">JPanel</span> <span class="n">currentUserPane</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JPanel</span><span class="o">();</span>
        <span class="n">currentUserPane</span><span class="o">.</span><span class="na">setLayout</span><span class="o">(</span><span class="k">new</span> <span class="nc">BorderLayout</span><span class="o">());</span>
        <span class="nc">Border</span> <span class="n">border</span> <span class="o">=</span> <span class="nc">BorderFactory</span><span class="o">.</span><span class="na">createEtchedBorder</span><span class="o">(</span><span class="nc">EtchedBorder</span><span class="o">.</span><span class="na">LOWERED</span><span class="o">);</span>
        <span class="n">currentUserPane</span><span class="o">.</span><span class="na">setBorder</span><span class="o">(</span><span class="nc">BorderFactory</span><span class="o">.</span><span class="na">createTitledBorder</span><span class="o">(</span><span class="n">border</span><span class="o">,</span>
                <span class="s">"当前用户"</span><span class="o">,</span> <span class="nc">TitledBorder</span><span class="o">.</span><span class="na">LEFT</span><span class="o">,</span><span class="nc">TitledBorder</span><span class="o">.</span><span class="na">TOP</span><span class="o">));</span>
        <span class="k">this</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">currentUserPane</span><span class="o">,</span> <span class="nc">BorderLayout</span><span class="o">.</span><span class="na">NORTH</span><span class="o">);</span>

        <span class="c1">// 右边用户列表创建一个分隔窗格</span>
        <span class="nc">JSplitPane</span> <span class="n">splitPane3</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JSplitPane</span><span class="o">(</span><span class="nc">JSplitPane</span><span class="o">.</span><span class="na">VERTICAL_SPLIT</span><span class="o">,</span>
                <span class="n">currentUserPane</span><span class="o">,</span> <span class="n">onlineListPane</span><span class="o">);</span>
        <span class="n">splitPane3</span><span class="o">.</span><span class="na">setDividerLocation</span><span class="o">(</span><span class="mi">60</span><span class="o">);</span>
        <span class="n">splitPane3</span><span class="o">.</span><span class="na">setDividerSize</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">userPanel</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">splitPane3</span><span class="o">,</span> <span class="nc">BorderLayout</span><span class="o">.</span><span class="na">CENTER</span><span class="o">);</span>

        <span class="c1">//获取在线用户并缓存</span>
        <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUserListModel</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OnlineUserListModel</span><span class="o">(</span><span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUsers</span><span class="o">);</span>
        <span class="c1">//在线用户列表</span>
        <span class="n">onlineList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JList</span><span class="o">(</span><span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUserListModel</span><span class="o">);</span>
        <span class="n">onlineList</span><span class="o">.</span><span class="na">setCellRenderer</span><span class="o">(</span><span class="k">new</span> <span class="nc">MyCellRenderer</span><span class="o">());</span>
        <span class="c1">//设置为单选模式</span>
        <span class="n">onlineList</span><span class="o">.</span><span class="na">setSelectionMode</span><span class="o">(</span><span class="nc">ListSelectionModel</span><span class="o">.</span><span class="na">SINGLE_SELECTION</span><span class="o">);</span>
        <span class="n">onlineListPane</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">JScrollPane</span><span class="o">(</span><span class="n">onlineList</span><span class="o">,</span>
                <span class="nc">JScrollPane</span><span class="o">.</span><span class="na">VERTICAL_SCROLLBAR_AS_NEEDED</span><span class="o">,</span>
                <span class="nc">JScrollPane</span><span class="o">.</span><span class="na">HORIZONTAL_SCROLLBAR_NEVER</span><span class="o">));</span>

        <span class="c1">//当前用户信息Label</span>
        <span class="n">currentUserLbl</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JLabel</span><span class="o">();</span>
        <span class="n">currentUserPane</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">currentUserLbl</span><span class="o">);</span>


        <span class="c1">//右上方信息显示面板</span>
        <span class="nc">JPanel</span> <span class="n">infoPanel</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JPanel</span><span class="o">();</span>
        <span class="n">infoPanel</span><span class="o">.</span><span class="na">setLayout</span><span class="o">(</span><span class="k">new</span> <span class="nc">BorderLayout</span><span class="o">());</span>
        <span class="c1">//右下方发送消息面板</span>
        <span class="nc">JPanel</span> <span class="n">sendPanel</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JPanel</span><span class="o">();</span>
        <span class="n">sendPanel</span><span class="o">.</span><span class="na">setLayout</span><span class="o">(</span><span class="k">new</span> <span class="nc">BorderLayout</span><span class="o">());</span>

        <span class="c1">// 创建一个分隔窗格</span>
        <span class="nc">JSplitPane</span> <span class="n">splitPane2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JSplitPane</span><span class="o">(</span><span class="nc">JSplitPane</span><span class="o">.</span><span class="na">VERTICAL_SPLIT</span><span class="o">,</span>
                <span class="n">infoPanel</span><span class="o">,</span> <span class="n">sendPanel</span><span class="o">);</span>
        <span class="n">splitPane2</span><span class="o">.</span><span class="na">setDividerLocation</span><span class="o">(</span><span class="mi">300</span><span class="o">);</span>
        <span class="n">splitPane2</span><span class="o">.</span><span class="na">setDividerSize</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">mainPanel</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">splitPane2</span><span class="o">,</span> <span class="nc">BorderLayout</span><span class="o">.</span><span class="na">CENTER</span><span class="o">);</span>

        <span class="n">otherInfoLbl</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JLabel</span><span class="o">(</span><span class="s">"当前状态：群聊中..."</span><span class="o">);</span>
        <span class="n">infoPanel</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">otherInfoLbl</span><span class="o">,</span> <span class="nc">BorderLayout</span><span class="o">.</span><span class="na">NORTH</span><span class="o">);</span>

        <span class="n">msgListArea</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JTextArea</span><span class="o">();</span>
        <span class="n">msgListArea</span><span class="o">.</span><span class="na">setLineWrap</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="c1">//给信息窗口添加滚动条</span>
        <span class="n">infoPanel</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">JScrollPane</span><span class="o">(</span><span class="n">msgListArea</span><span class="o">,</span>
                <span class="nc">JScrollPane</span><span class="o">.</span><span class="na">VERTICAL_SCROLLBAR_AS_NEEDED</span><span class="o">,</span>
                <span class="nc">JScrollPane</span><span class="o">.</span><span class="na">HORIZONTAL_SCROLLBAR_NEVER</span><span class="o">));</span>

        <span class="nc">JPanel</span> <span class="n">tempPanel</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JPanel</span><span class="o">();</span>
        <span class="n">tempPanel</span><span class="o">.</span><span class="na">setLayout</span><span class="o">(</span><span class="k">new</span> <span class="nc">BorderLayout</span><span class="o">());</span>
        <span class="n">sendPanel</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">tempPanel</span><span class="o">,</span> <span class="nc">BorderLayout</span><span class="o">.</span><span class="na">NORTH</span><span class="o">);</span>

        <span class="c1">// 聊天按钮面板</span>
        <span class="nc">JPanel</span> <span class="n">btnPanel</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JPanel</span><span class="o">();</span>
        <span class="n">btnPanel</span><span class="o">.</span><span class="na">setLayout</span><span class="o">(</span><span class="k">new</span> <span class="nc">FlowLayout</span><span class="o">(</span><span class="nc">FlowLayout</span><span class="o">.</span><span class="na">LEFT</span><span class="o">));</span>
        <span class="n">tempPanel</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">btnPanel</span><span class="o">,</span> <span class="nc">BorderLayout</span><span class="o">.</span><span class="na">CENTER</span><span class="o">);</span>

        <span class="c1">//字体按钮</span>
        <span class="nc">JButton</span> <span class="n">fontBtn</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JButton</span><span class="o">(</span><span class="k">new</span> <span class="nc">ImageIcon</span><span class="o">(</span><span class="s">"images/font.png"</span><span class="o">));</span>
        <span class="n">fontBtn</span><span class="o">.</span><span class="na">setMargin</span><span class="o">(</span><span class="k">new</span> <span class="nc">Insets</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">));</span>
        <span class="n">fontBtn</span><span class="o">.</span><span class="na">setToolTipText</span><span class="o">(</span><span class="s">"设置字体和格式"</span><span class="o">);</span>
        <span class="n">btnPanel</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">fontBtn</span><span class="o">);</span>

        <span class="c1">//表情按钮</span>
        <span class="nc">JButton</span> <span class="n">faceBtn</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JButton</span><span class="o">(</span><span class="k">new</span> <span class="nc">ImageIcon</span><span class="o">(</span><span class="s">"images/sendFace.png"</span><span class="o">));</span>
        <span class="n">faceBtn</span><span class="o">.</span><span class="na">setMargin</span><span class="o">(</span><span class="k">new</span> <span class="nc">Insets</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">));</span>
        <span class="n">faceBtn</span><span class="o">.</span><span class="na">setToolTipText</span><span class="o">(</span><span class="s">"选择表情"</span><span class="o">);</span>
        <span class="n">btnPanel</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">faceBtn</span><span class="o">);</span>

        <span class="c1">//发送文件按钮</span>
        <span class="nc">JButton</span> <span class="n">sendFileBtn</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JButton</span><span class="o">(</span><span class="k">new</span> <span class="nc">ImageIcon</span><span class="o">(</span><span class="s">"images/sendPic.png"</span><span class="o">));</span>
        <span class="n">sendFileBtn</span><span class="o">.</span><span class="na">setMargin</span><span class="o">(</span><span class="k">new</span> <span class="nc">Insets</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">));</span>
        <span class="n">sendFileBtn</span><span class="o">.</span><span class="na">setToolTipText</span><span class="o">(</span><span class="s">"向对方发送文件"</span><span class="o">);</span>
        <span class="n">btnPanel</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">sendFileBtn</span><span class="o">);</span>

        <span class="c1">//私聊按钮</span>
        <span class="n">rybqBtn</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JCheckBox</span><span class="o">(</span><span class="s">"私聊"</span><span class="o">);</span>
        <span class="n">tempPanel</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">rybqBtn</span><span class="o">,</span> <span class="nc">BorderLayout</span><span class="o">.</span><span class="na">EAST</span><span class="o">);</span>

        <span class="c1">//要发送的信息的区域</span>
        <span class="n">sendArea</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JTextArea</span><span class="o">();</span>
        <span class="n">sendArea</span><span class="o">.</span><span class="na">setLineWrap</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">sendPanel</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">JScrollPane</span><span class="o">(</span><span class="n">sendArea</span><span class="o">,</span>
                <span class="nc">JScrollPane</span><span class="o">.</span><span class="na">VERTICAL_SCROLLBAR_AS_NEEDED</span><span class="o">,</span>
                <span class="nc">JScrollPane</span><span class="o">.</span><span class="na">HORIZONTAL_SCROLLBAR_NEVER</span><span class="o">));</span>

        <span class="c1">// 聊天按钮面板</span>
        <span class="nc">JPanel</span> <span class="n">btn2Panel</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JPanel</span><span class="o">();</span>
        <span class="n">btn2Panel</span><span class="o">.</span><span class="na">setLayout</span><span class="o">(</span><span class="k">new</span> <span class="nc">FlowLayout</span><span class="o">(</span><span class="nc">FlowLayout</span><span class="o">.</span><span class="na">RIGHT</span><span class="o">));</span>
        <span class="k">this</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">btn2Panel</span><span class="o">,</span> <span class="nc">BorderLayout</span><span class="o">.</span><span class="na">SOUTH</span><span class="o">);</span>
        <span class="nc">JButton</span> <span class="n">closeBtn</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JButton</span><span class="o">(</span><span class="s">"关闭"</span><span class="o">);</span>
        <span class="n">closeBtn</span><span class="o">.</span><span class="na">setToolTipText</span><span class="o">(</span><span class="s">"退出程序"</span><span class="o">);</span>
        <span class="n">btn2Panel</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">closeBtn</span><span class="o">);</span>
        <span class="nc">JButton</span> <span class="n">submitBtn</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JButton</span><span class="o">(</span><span class="s">"发送"</span><span class="o">);</span>
        <span class="n">submitBtn</span><span class="o">.</span><span class="na">setToolTipText</span><span class="o">(</span><span class="s">"按Enter键发送消息"</span><span class="o">);</span>
        <span class="n">btn2Panel</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">submitBtn</span><span class="o">);</span>
        <span class="n">sendPanel</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">btn2Panel</span><span class="o">,</span> <span class="nc">BorderLayout</span><span class="o">.</span><span class="na">SOUTH</span><span class="o">);</span>

        <span class="cm">/*-------注册事件监听器--------*/</span>
        <span class="c1">//关闭窗口</span>
        <span class="k">this</span><span class="o">.</span><span class="na">addWindowListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">WindowAdapter</span><span class="o">(){</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">windowClosing</span><span class="o">(</span><span class="nc">WindowEvent</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">logout</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">});</span>

        <span class="c1">//关闭按钮的事件</span>
        <span class="n">closeBtn</span><span class="o">.</span><span class="na">addActionListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">ActionListener</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">actionPerformed</span><span class="o">(</span><span class="nc">ActionEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">logout</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">});</span>

        <span class="c1">//选择某个用户私聊</span>
        <span class="n">rybqBtn</span><span class="o">.</span><span class="na">addActionListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">ActionListener</span><span class="o">(){</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">actionPerformed</span><span class="o">(</span><span class="nc">ActionEvent</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span><span class="o">(</span><span class="n">rybqBtn</span><span class="o">.</span><span class="na">isSelected</span><span class="o">()){</span>
                    <span class="nc">User</span> <span class="n">selectedUser</span> <span class="o">=</span> <span class="o">(</span><span class="nc">User</span><span class="o">)</span><span class="n">onlineList</span><span class="o">.</span><span class="na">getSelectedValue</span><span class="o">();</span>
                    <span class="k">if</span><span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">selectedUser</span><span class="o">){</span>
                        <span class="n">otherInfoLbl</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">"当前状态：私聊(从在线用户列表中选择某个用户进行私聊)..."</span><span class="o">);</span>
                    <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="nc">DataBuffer</span><span class="o">.</span><span class="na">currentUser</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">==</span> <span class="n">selectedUser</span><span class="o">.</span><span class="na">getId</span><span class="o">()){</span>
                        <span class="n">otherInfoLbl</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">"警告：不允许和自己私聊！！！"</span><span class="o">);</span>
                    <span class="o">}</span><span class="k">else</span><span class="o">{</span>
                        <span class="n">otherInfoLbl</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">"当前状态：与 "</span><span class="o">+</span> <span class="n">selectedUser</span><span class="o">.</span><span class="na">getNickname</span><span class="o">()</span>
                                <span class="o">+</span><span class="s">"("</span> <span class="o">+</span> <span class="n">selectedUser</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">") 私聊中..."</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span><span class="k">else</span><span class="o">{</span>
                    <span class="n">otherInfoLbl</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">"当前状态：群聊..."</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>


        <span class="c1">//选择某个用户</span>
        <span class="n">onlineList</span><span class="o">.</span><span class="na">addMouseListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">MouseAdapter</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">mouseClicked</span><span class="o">(</span><span class="nc">MouseEvent</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">User</span> <span class="n">selectedUser</span> <span class="o">=</span> <span class="o">(</span><span class="nc">User</span><span class="o">)</span><span class="n">onlineList</span><span class="o">.</span><span class="na">getSelectedValue</span><span class="o">();</span>
                <span class="k">if</span><span class="o">(</span><span class="n">rybqBtn</span><span class="o">.</span><span class="na">isSelected</span><span class="o">()){</span>
                    <span class="k">if</span><span class="o">(</span><span class="nc">DataBuffer</span><span class="o">.</span><span class="na">currentUser</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">==</span> <span class="n">selectedUser</span><span class="o">.</span><span class="na">getId</span><span class="o">()){</span>
                        <span class="n">otherInfoLbl</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">"警告：不允许和自己私聊！！！"</span><span class="o">);</span>
                    <span class="o">}</span><span class="k">else</span><span class="o">{</span>
                        <span class="n">otherInfoLbl</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">"当前状态：与 "</span><span class="o">+</span> <span class="n">selectedUser</span><span class="o">.</span><span class="na">getNickname</span><span class="o">()</span>
                                <span class="o">+</span><span class="s">"("</span> <span class="o">+</span> <span class="n">selectedUser</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">") 私聊中..."</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>

        <span class="c1">//发送文本消息</span>
        <span class="c1">//回车发送</span>
        <span class="n">sendArea</span><span class="o">.</span><span class="na">addKeyListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">KeyAdapter</span><span class="o">(){</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">keyPressed</span><span class="o">(</span><span class="nc">KeyEvent</span> <span class="n">e</span><span class="o">){</span>
                <span class="k">if</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getKeyCode</span><span class="o">()</span> <span class="o">==</span> <span class="nc">KeyEvent</span><span class="o">.</span><span class="na">VK_ENTER</span><span class="o">){</span>
                    <span class="n">sendTxtMsg</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="c1">//点击按钮发送</span>
        <span class="n">submitBtn</span><span class="o">.</span><span class="na">addActionListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">ActionListener</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">actionPerformed</span><span class="o">(</span><span class="nc">ActionEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sendTxtMsg</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">});</span>


        <span class="c1">//发送文件</span>
        <span class="n">sendFileBtn</span><span class="o">.</span><span class="na">addActionListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">ActionListener</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">actionPerformed</span><span class="o">(</span><span class="nc">ActionEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">sendFile</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">});</span>

        <span class="k">this</span><span class="o">.</span><span class="na">loadData</span><span class="o">();</span>  <span class="c1">//加载初始数据</span>
    <span class="o">}</span>


    <span class="c1">//加载数据</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">loadData</span><span class="o">(){</span>
        <span class="c1">//加载当前用户数据</span>
        <span class="k">if</span><span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">currentUser</span><span class="o">){</span>
            <span class="c1">//头像</span>
            <span class="n">currentUserLbl</span><span class="o">.</span><span class="na">setIcon</span><span class="o">(</span>
                    <span class="k">new</span> <span class="nf">ImageIcon</span><span class="o">(</span><span class="s">"images/"</span> <span class="o">+</span> <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">currentUser</span><span class="o">.</span><span class="na">getHead</span><span class="o">()</span> <span class="o">+</span> <span class="s">".png"</span><span class="o">));</span>
            <span class="c1">//用户昵称和账号</span>
            <span class="n">currentUserLbl</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="nc">DataBuffer</span><span class="o">.</span><span class="na">currentUser</span><span class="o">.</span><span class="na">getNickname</span><span class="o">()</span>
                    <span class="o">+</span> <span class="s">"("</span> <span class="o">+</span> <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">currentUser</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">")"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">//设置在线用户列表</span>
        <span class="n">onlineCountLbl</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">"在线用户列表("</span><span class="o">+</span> <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUserListModel</span><span class="o">.</span><span class="na">getSize</span><span class="o">()</span> <span class="o">+</span><span class="s">")"</span><span class="o">);</span>
        <span class="c1">//启动监听服务器消息的线程</span>
        <span class="k">new</span> <span class="nf">ClientThread</span><span class="o">(</span><span class="k">this</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>


    <span class="c1">//关闭客户端</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">logout</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//弹出提示窗口</span>
        <span class="kt">int</span> <span class="n">select</span> <span class="o">=</span> <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">showConfirmDialog</span><span class="o">(</span><span class="nc">ChatFrame</span><span class="o">.</span><span class="na">this</span><span class="o">,</span>
                <span class="s">"确定要退出吗？\n\n退出程序将会中断与服务器的连接!"</span><span class="o">,</span> <span class="s">"退出聊天室"</span><span class="o">,</span>
                <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">YES_NO_OPTION</span><span class="o">);</span>
        <span class="c1">//选择退出</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">select</span> <span class="o">==</span> <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">YES_OPTION</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//创建请求对象</span>
            <span class="nc">Request</span> <span class="n">req</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Request</span><span class="o">();</span>
            <span class="n">req</span><span class="o">.</span><span class="na">setAction</span><span class="o">(</span><span class="s">"exit"</span><span class="o">);</span>
            <span class="n">req</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"user"</span><span class="o">,</span> <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">currentUser</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">//发送请求</span>
                <span class="nc">ClientUtil</span><span class="o">.</span><span class="na">sendTextRequest</span><span class="o">(</span><span class="n">req</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">ex</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span><span class="k">finally</span><span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
            <span class="c1">// 未选择退出 不响应</span>
            <span class="k">this</span><span class="o">.</span><span class="na">setDefaultCloseOperation</span><span class="o">(</span><span class="no">DO_NOTHING_ON_CLOSE</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">//服务器踢除用户</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">remove</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">select</span> <span class="o">=</span> <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">showConfirmDialog</span><span class="o">(</span><span class="n">sendArea</span><span class="o">,</span>
                <span class="s">"你已被踢出聊天室！\n\n"</span><span class="o">,</span> <span class="s">"系统通知"</span><span class="o">,</span>
                <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">YES_NO_OPTION</span><span class="o">);</span>
        <span class="c1">//创建请求对象   等同于用户退出</span>
        <span class="nc">Request</span> <span class="n">req</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Request</span><span class="o">();</span>
        <span class="n">req</span><span class="o">.</span><span class="na">setAction</span><span class="o">(</span><span class="s">"exit"</span><span class="o">);</span>
        <span class="n">req</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"user"</span><span class="o">,</span> <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">currentUser</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">ClientUtil</span><span class="o">.</span><span class="na">sendTextRequest</span><span class="o">(</span><span class="n">req</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">ex</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="o">}</span>

    <span class="o">}</span>


    <span class="c1">//发送文本消息</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendTxtMsg</span><span class="o">(){</span>
        <span class="nc">String</span> <span class="n">content</span> <span class="o">=</span> <span class="n">sendArea</span><span class="o">.</span><span class="na">getText</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="s">""</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">content</span><span class="o">))</span> <span class="o">{</span> <span class="c1">//无内容</span>
            <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">showMessageDialog</span><span class="o">(</span><span class="nc">ChatFrame</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="s">"不能发送空消息!"</span><span class="o">,</span>
                    <span class="s">"不能发送"</span><span class="o">,</span> <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">ERROR_MESSAGE</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span> <span class="c1">//发送</span>
            <span class="nc">User</span> <span class="n">selectedUser</span> <span class="o">=</span> <span class="o">(</span><span class="nc">User</span><span class="o">)</span><span class="n">onlineList</span><span class="o">.</span><span class="na">getSelectedValue</span><span class="o">();</span>

            <span class="c1">//如果设置了ToUser 表示私聊，否则群聊</span>
            <span class="nc">Message</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Message</span><span class="o">();</span>
            <span class="k">if</span><span class="o">(</span><span class="n">rybqBtn</span><span class="o">.</span><span class="na">isSelected</span><span class="o">()){</span>  <span class="c1">//私聊</span>
                <span class="k">if</span><span class="o">(</span><span class="kc">null</span> <span class="o">==</span> <span class="n">selectedUser</span><span class="o">){</span><span class="c1">//私聊对象为空</span>
                    <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">showMessageDialog</span><span class="o">(</span><span class="nc">ChatFrame</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="s">"没有选择私聊对象!"</span><span class="o">,</span>
                            <span class="s">"不能发送"</span><span class="o">,</span> <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">ERROR_MESSAGE</span><span class="o">);</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span><span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="nc">DataBuffer</span><span class="o">.</span><span class="na">currentUser</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">==</span> <span class="n">selectedUser</span><span class="o">.</span><span class="na">getId</span><span class="o">()){</span><span class="c1">//私聊对象为自己</span>
                    <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">showMessageDialog</span><span class="o">(</span><span class="nc">ChatFrame</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="s">"不能给自己发送消息!"</span><span class="o">,</span>
                            <span class="s">"不能发送"</span><span class="o">,</span> <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">ERROR_MESSAGE</span><span class="o">);</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span><span class="k">else</span><span class="o">{</span>
                    <span class="n">msg</span><span class="o">.</span><span class="na">setToUser</span><span class="o">(</span><span class="n">selectedUser</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="c1">//获取系统时间</span>
            <span class="n">msg</span><span class="o">.</span><span class="na">setFromUser</span><span class="o">(</span><span class="nc">DataBuffer</span><span class="o">.</span><span class="na">currentUser</span><span class="o">);</span>
            <span class="n">msg</span><span class="o">.</span><span class="na">setSendTime</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>
            <span class="nc">DateFormat</span> <span class="n">df</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SimpleDateFormat</span><span class="o">(</span><span class="s">"HH:mm:ss"</span><span class="o">);</span>
            <span class="c1">//存储消息的相关信息</span>
            <span class="nc">StringBuffer</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuffer</span><span class="o">();</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">" "</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">df</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getSendTime</span><span class="o">())).</span><span class="na">append</span><span class="o">(</span><span class="s">" "</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getFromUser</span><span class="o">().</span><span class="na">getNickname</span><span class="o">())</span>
                    <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"("</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getFromUser</span><span class="o">().</span><span class="na">getId</span><span class="o">()).</span><span class="na">append</span><span class="o">(</span><span class="s">") "</span><span class="o">);</span>
            <span class="k">if</span><span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">rybqBtn</span><span class="o">.</span><span class="na">isSelected</span><span class="o">()){</span> <span class="c1">//群聊</span>
                <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"对大家说"</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"\n  "</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">content</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">"\n"</span><span class="o">);</span>
            <span class="n">msg</span><span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
            <span class="c1">//创建请求对象  存储消息信息</span>
            <span class="nc">Request</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Request</span><span class="o">();</span>
            <span class="n">request</span><span class="o">.</span><span class="na">setAction</span><span class="o">(</span><span class="s">"chat"</span><span class="o">);</span>
            <span class="n">request</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"msg"</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">//发送请求</span>
                <span class="nc">ClientUtil</span><span class="o">.</span><span class="na">sendTextRequest2</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="c1">//JTextArea 中发送消息后，清空内容并回到首行</span>
            <span class="nc">InputMap</span> <span class="n">inputMap</span> <span class="o">=</span> <span class="n">sendArea</span><span class="o">.</span><span class="na">getInputMap</span><span class="o">();</span>
            <span class="nc">ActionMap</span> <span class="n">actionMap</span> <span class="o">=</span> <span class="n">sendArea</span><span class="o">.</span><span class="na">getActionMap</span><span class="o">();</span>
            <span class="nc">Object</span> <span class="n">transferTextActionKey</span> <span class="o">=</span> <span class="s">"TRANSFER_TEXT"</span><span class="o">;</span>
            <span class="n">inputMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">KeyStroke</span><span class="o">.</span><span class="na">getKeyStroke</span><span class="o">(</span><span class="nc">KeyEvent</span><span class="o">.</span><span class="na">VK_ENTER</span><span class="o">,</span><span class="mi">0</span><span class="o">),</span><span class="n">transferTextActionKey</span><span class="o">);</span>
            <span class="n">actionMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">transferTextActionKey</span><span class="o">,</span><span class="k">new</span> <span class="nc">AbstractAction</span><span class="o">()</span> <span class="o">{</span>
                <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">7041841945830590229L</span><span class="o">;</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">actionPerformed</span><span class="o">(</span><span class="nc">ActionEvent</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">sendArea</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
                    <span class="n">sendArea</span><span class="o">.</span><span class="na">requestFocus</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="n">sendArea</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
            <span class="nc">ClientUtil</span><span class="o">.</span><span class="na">appendTxt2MsgListArea</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">//发送文件</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">sendFile</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">User</span> <span class="n">selectedUser</span> <span class="o">=</span> <span class="o">(</span><span class="nc">User</span><span class="o">)</span><span class="n">onlineList</span><span class="o">.</span><span class="na">getSelectedValue</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">selectedUser</span><span class="o">){</span> <span class="c1">//选择了发送文件的对象</span>
            <span class="k">if</span><span class="o">(</span><span class="nc">DataBuffer</span><span class="o">.</span><span class="na">currentUser</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">==</span> <span class="n">selectedUser</span><span class="o">.</span><span class="na">getId</span><span class="o">()){</span>
                <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">showMessageDialog</span><span class="o">(</span><span class="nc">ChatFrame</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="s">"不能给自己发送文件!"</span><span class="o">,</span>
                        <span class="s">"不能发送"</span><span class="o">,</span> <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">ERROR_MESSAGE</span><span class="o">);</span>
            <span class="o">}</span><span class="k">else</span><span class="o">{</span>
                <span class="c1">//选择要发送的文件</span>
                <span class="nc">JFileChooser</span> <span class="n">jfc</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JFileChooser</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">jfc</span><span class="o">.</span><span class="na">showOpenDialog</span><span class="o">(</span><span class="nc">ChatFrame</span><span class="o">.</span><span class="na">this</span><span class="o">)</span> <span class="o">==</span> <span class="nc">JFileChooser</span><span class="o">.</span><span class="na">APPROVE_OPTION</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">File</span> <span class="n">file</span> <span class="o">=</span> <span class="n">jfc</span><span class="o">.</span><span class="na">getSelectedFile</span><span class="o">();</span>
                    <span class="c1">//创建要发送的文件对象 存储文件内容及相关信息</span>
                    <span class="n">sendFile</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInfo</span><span class="o">();</span>
                    <span class="c1">//设置文件发送者</span>
                    <span class="n">sendFile</span><span class="o">.</span><span class="na">setFromUser</span><span class="o">(</span><span class="nc">DataBuffer</span><span class="o">.</span><span class="na">currentUser</span><span class="o">);</span>
                    <span class="c1">//设置文件接收者</span>
                    <span class="n">sendFile</span><span class="o">.</span><span class="na">setToUser</span><span class="o">(</span><span class="n">selectedUser</span><span class="o">);</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="c1">//待发送文件的源地址及文件名</span>
                        <span class="n">sendFile</span><span class="o">.</span><span class="na">setSrcName</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">getCanonicalPath</span><span class="o">());</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e1</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">e1</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                    <span class="o">}</span>
                    <span class="c1">//设置发送时间</span>
                    <span class="n">sendFile</span><span class="o">.</span><span class="na">setSendTime</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>
                    <span class="c1">//创建请求对象</span>
                    <span class="nc">Request</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Request</span><span class="o">();</span>
                    <span class="n">request</span><span class="o">.</span><span class="na">setAction</span><span class="o">(</span><span class="s">"toSendFile"</span><span class="o">);</span>
                    <span class="n">request</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"file"</span><span class="o">,</span> <span class="n">sendFile</span><span class="o">);</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="c1">//发送请求</span>
                        <span class="nc">ClientUtil</span><span class="o">.</span><span class="na">sendTextRequest2</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                    <span class="o">}</span>
                    <span class="c1">//打印提示信息</span>
                    <span class="nc">ClientUtil</span><span class="o">.</span><span class="na">appendTxt2MsgListArea</span><span class="o">(</span><span class="s">"【文件消息】向 "</span>
                            <span class="o">+</span> <span class="n">selectedUser</span><span class="o">.</span><span class="na">getNickname</span><span class="o">()</span> <span class="o">+</span> <span class="s">"("</span>
                            <span class="o">+</span> <span class="n">selectedUser</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">") 发送文件 ["</span>
                            <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"]，等待对方接收...\n"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
            <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">showMessageDialog</span><span class="o">(</span><span class="nc">ChatFrame</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="s">"警告：只能给指定用户发送文件！！！"</span><span class="o">,</span>
                    <span class="s">"不能发送"</span><span class="o">,</span> <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">ERROR_MESSAGE</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>


<span class="o">}</span>
</pre></table></code></div></div><h3 id="logingui"><span class="mr-2">LoginGUI</span><a href="#logingui" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>登录界面大致如下</p><p><img data-src="/assets/blog_res/2022-06-16-client.assets/3.png" alt="3" data-proofer-ignore></p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoginGUI</span> <span class="kd">extends</span> <span class="nc">JFrame</span><span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3426717670093483287L</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">JTextField</span> <span class="n">idTxt</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">JPasswordField</span> <span class="n">pwdFld</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nf">LoginFrame</span><span class="o">(){</span>
        <span class="k">this</span><span class="o">.</span><span class="na">init</span><span class="o">();</span>
        <span class="n">setVisible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(){</span>
        <span class="k">this</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="s">"登录"</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">setSize</span><span class="o">(</span><span class="mi">430</span><span class="o">,</span><span class="mi">330</span><span class="o">);</span>

        <span class="c1">//设置默认窗口在屏幕中央</span>
        <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="nc">Toolkit</span><span class="o">.</span><span class="na">getDefaultToolkit</span><span class="o">().</span><span class="na">getScreenSize</span><span class="o">().</span><span class="na">getWidth</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span><span class="nc">Toolkit</span><span class="o">.</span><span class="na">getDefaultToolkit</span><span class="o">().</span><span class="na">getScreenSize</span><span class="o">().</span><span class="na">getHeight</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">setLocation</span><span class="o">((</span><span class="n">x</span><span class="o">-</span><span class="k">this</span><span class="o">.</span><span class="na">getWidth</span><span class="o">())/</span><span class="mi">2</span><span class="o">,(</span><span class="n">y</span><span class="o">-</span><span class="k">this</span><span class="o">.</span><span class="na">getHeight</span><span class="o">())/</span><span class="mi">2</span><span class="o">);</span>

        <span class="c1">//不允许用户改变窗口大小；</span>
        <span class="k">this</span><span class="o">.</span><span class="na">setResizable</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

        <span class="c1">//把logo放在JFrame的上面</span>
        <span class="nc">Icon</span> <span class="n">icon</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ImageIcon</span><span class="o">(</span><span class="s">"images/logo.png"</span><span class="o">);</span>
        <span class="nc">JLabel</span> <span class="n">label</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JLabel</span><span class="o">(</span><span class="n">icon</span><span class="o">);</span>
        <span class="n">label</span><span class="o">.</span><span class="na">setPreferredSize</span><span class="o">(</span><span class="k">new</span> <span class="nc">Dimension</span><span class="o">(</span><span class="mi">430</span><span class="o">,</span><span class="mi">150</span><span class="o">));</span>
        <span class="k">this</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">label</span><span class="o">,</span><span class="nc">BorderLayout</span><span class="o">.</span><span class="na">NORTH</span><span class="o">);</span>

        <span class="c1">//登录信息</span>
        <span class="nc">JPanel</span> <span class="n">mainPanel</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JPanel</span><span class="o">();</span>
        <span class="c1">// 具有“浮雕化”外观效果的边框(效果为凹陷)</span>
        <span class="nc">Border</span> <span class="n">border</span> <span class="o">=</span> <span class="nc">BorderFactory</span><span class="o">.</span><span class="na">createEtchedBorder</span><span class="o">(</span><span class="nc">EtchedBorder</span><span class="o">.</span><span class="na">LOWERED</span><span class="o">);</span>
        <span class="n">mainPanel</span><span class="o">.</span><span class="na">setBorder</span><span class="o">(</span><span class="nc">BorderFactory</span><span class="o">.</span><span class="na">createTitledBorder</span><span class="o">(</span><span class="n">border</span><span class="o">,</span><span class="s">"输入登录信息"</span><span class="o">,</span><span class="nc">TitledBorder</span><span class="o">.</span><span class="na">CENTER</span><span class="o">,</span><span class="nc">TitledBorder</span><span class="o">.</span><span class="na">TOP</span><span class="o">));</span>
        <span class="k">this</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">mainPanel</span><span class="o">,</span><span class="nc">BorderLayout</span><span class="o">.</span><span class="na">CENTER</span><span class="o">);</span>
        <span class="n">mainPanel</span><span class="o">.</span><span class="na">setLayout</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>

        <span class="nc">JLabel</span> <span class="n">nameLbl</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JLabel</span><span class="o">(</span><span class="s">"账号"</span><span class="o">);</span>
        <span class="n">nameLbl</span><span class="o">.</span><span class="na">setBounds</span><span class="o">(</span><span class="mi">110</span><span class="o">,</span><span class="mi">30</span><span class="o">,</span><span class="mi">70</span><span class="o">,</span><span class="mi">22</span><span class="o">);</span>
        <span class="n">mainPanel</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">nameLbl</span><span class="o">);</span>
        <span class="n">idTxt</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JTextField</span><span class="o">();</span>
        <span class="n">idTxt</span><span class="o">.</span><span class="na">setBounds</span><span class="o">(</span><span class="mi">150</span><span class="o">,</span><span class="mi">30</span><span class="o">,</span><span class="mi">150</span><span class="o">,</span><span class="mi">22</span><span class="o">);</span>
        <span class="n">idTxt</span><span class="o">.</span><span class="na">requestFocusInWindow</span><span class="o">();</span><span class="c1">//用户名获得焦点</span>
        <span class="n">mainPanel</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">idTxt</span><span class="o">);</span>

        <span class="nc">JLabel</span> <span class="n">pwdLbl</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JLabel</span><span class="o">(</span><span class="s">"密码"</span><span class="o">);</span>
        <span class="n">pwdLbl</span><span class="o">.</span><span class="na">setBounds</span><span class="o">(</span><span class="mi">110</span><span class="o">,</span><span class="mi">60</span><span class="o">,</span><span class="mi">40</span><span class="o">,</span><span class="mi">22</span><span class="o">);</span>
        <span class="n">mainPanel</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">pwdLbl</span><span class="o">);</span>
        <span class="n">pwdFld</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JPasswordField</span><span class="o">();</span>
        <span class="n">pwdFld</span><span class="o">.</span><span class="na">setBounds</span><span class="o">(</span><span class="mi">150</span><span class="o">,</span><span class="mi">60</span><span class="o">,</span><span class="mi">150</span><span class="o">,</span><span class="mi">22</span><span class="o">);</span>
        <span class="n">mainPanel</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">pwdFld</span><span class="o">);</span>

        <span class="c1">//按钮面板放置在JFrame的下面</span>
        <span class="nc">JPanel</span> <span class="n">btnPanel</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JPanel</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">btnPanel</span><span class="o">,</span><span class="nc">BorderLayout</span><span class="o">.</span><span class="na">SOUTH</span><span class="o">);</span>
        <span class="n">btnPanel</span><span class="o">.</span><span class="na">setLayout</span><span class="o">(</span><span class="k">new</span> <span class="nc">BorderLayout</span><span class="o">());</span>
        <span class="n">btnPanel</span><span class="o">.</span><span class="na">setBorder</span><span class="o">(</span><span class="k">new</span> <span class="nc">EmptyBorder</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span><span class="mi">8</span><span class="o">,</span><span class="mi">4</span><span class="o">,</span><span class="mi">8</span><span class="o">));</span>

        <span class="nc">JButton</span> <span class="n">registenBtn</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JButton</span><span class="o">(</span><span class="s">"注册"</span><span class="o">);</span>
        <span class="n">btnPanel</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">registenBtn</span><span class="o">,</span><span class="nc">BorderLayout</span><span class="o">.</span><span class="na">WEST</span><span class="o">);</span>
        <span class="nc">JButton</span> <span class="n">submitBtn</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JButton</span><span class="o">(</span><span class="s">"登录"</span><span class="o">);</span>
        <span class="n">btnPanel</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">submitBtn</span><span class="o">,</span><span class="nc">BorderLayout</span><span class="o">.</span><span class="na">EAST</span><span class="o">);</span>

        <span class="c1">//关闭窗口</span>
        <span class="k">this</span><span class="o">.</span><span class="na">addWindowListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">WindowAdapter</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">windowClosing</span><span class="o">(</span><span class="nc">WindowEvent</span> <span class="n">e</span><span class="o">){</span>
                <span class="nc">Request</span> <span class="n">req</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Request</span><span class="o">();</span>
                <span class="n">req</span><span class="o">.</span><span class="na">setAction</span><span class="o">(</span><span class="s">"exit"</span><span class="o">);</span>
                <span class="k">try</span><span class="o">{</span>
                    <span class="nc">ClientUtil</span><span class="o">.</span><span class="na">sendTextRequest</span><span class="o">(</span><span class="n">req</span><span class="o">);</span>
                <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="nc">IOException</span> <span class="n">ex</span><span class="o">){</span>
                    <span class="n">ex</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>

        <span class="c1">//注册</span>
        <span class="n">registenBtn</span><span class="o">.</span><span class="na">addActionListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">ActionListener</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">actionPerformed</span><span class="o">(</span><span class="nc">ActionEvent</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">new</span> <span class="nf">RegisterFrame</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">});</span>

        <span class="c1">//登录</span>
        <span class="n">submitBtn</span><span class="o">.</span><span class="na">addActionListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">ActionListener</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">actionPerformed</span><span class="o">(</span><span class="nc">ActionEvent</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">login</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>
    <span class="c1">//登录</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">login</span><span class="o">(){</span>
        <span class="k">if</span><span class="o">(</span><span class="n">idTxt</span><span class="o">.</span><span class="na">getText</span><span class="o">().</span><span class="na">length</span><span class="o">()==</span><span class="mi">0</span><span class="o">||</span><span class="n">pwdFld</span><span class="o">.</span><span class="na">getPassword</span><span class="o">().</span><span class="na">length</span><span class="o">==</span><span class="mi">0</span><span class="o">){</span>
            <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">showMessageDialog</span><span class="o">(</span><span class="nc">LoginFrame</span><span class="o">.</span><span class="na">this</span><span class="o">,</span>
                    <span class="s">"请输入账号密码！，"</span> <span class="o">,</span>
                    <span class="s">"输入有误"</span><span class="o">,</span><span class="nc">JOptionPane</span><span class="o">.</span><span class="na">ERROR_MESSAGE</span><span class="o">);</span>
            <span class="n">idTxt</span><span class="o">.</span><span class="na">requestFocusInWindow</span><span class="o">();</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">//创建请求</span>
        <span class="nc">Request</span> <span class="n">req</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Request</span><span class="o">();</span>
        <span class="n">req</span><span class="o">.</span><span class="na">setAction</span><span class="o">(</span><span class="s">"userLogin"</span><span class="o">);</span>
        <span class="n">req</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"id"</span><span class="o">,</span> <span class="n">idTxt</span><span class="o">.</span><span class="na">getText</span><span class="o">());</span>
        <span class="n">req</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"password"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">pwdFld</span><span class="o">.</span><span class="na">getPassword</span><span class="o">()));</span>
        <span class="c1">//获取响应</span>
        <span class="nc">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">response</span> <span class="o">=</span> <span class="nc">ClientUtil</span><span class="o">.</span><span class="na">sendTextRequest</span><span class="o">(</span><span class="n">req</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e1</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">if</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">getStatus</span><span class="o">()</span> <span class="o">==</span> <span class="nc">ResponseStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">){</span>
            <span class="c1">//获取当前用户</span>
            <span class="nc">User</span> <span class="n">user2</span> <span class="o">=</span> <span class="o">(</span><span class="nc">User</span><span class="o">)</span><span class="n">response</span><span class="o">.</span><span class="na">getData</span><span class="o">(</span><span class="s">"user"</span><span class="o">);</span>
            <span class="k">if</span><span class="o">(</span><span class="n">user2</span><span class="o">!=</span> <span class="kc">null</span><span class="o">){</span> <span class="c1">//登录成功</span>
                <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">currentUser</span> <span class="o">=</span> <span class="n">user2</span><span class="o">;</span>
                <span class="c1">//获取当前在线用户列表</span>
                <span class="nc">DataBuffer</span><span class="o">.</span><span class="na">onlineUsers</span> <span class="o">=</span> <span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;)</span><span class="n">response</span><span class="o">.</span><span class="na">getData</span><span class="o">(</span><span class="s">"onlineUsers"</span><span class="o">);</span>

                <span class="nc">LoginFrame</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">dispose</span><span class="o">();</span>
                <span class="k">new</span> <span class="nf">ChatFrame</span><span class="o">();</span>  <span class="c1">//打开聊天窗口</span>
            <span class="o">}</span><span class="k">else</span><span class="o">{</span> <span class="c1">//登录失败</span>
                <span class="nc">String</span> <span class="n">str</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span><span class="n">response</span><span class="o">.</span><span class="na">getData</span><span class="o">(</span><span class="s">"msg"</span><span class="o">);</span>
                <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">showMessageDialog</span><span class="o">(</span><span class="nc">LoginFrame</span><span class="o">.</span><span class="na">this</span><span class="o">,</span>
                        <span class="n">str</span><span class="o">,</span>
                        <span class="s">"登录失败"</span><span class="o">,</span><span class="nc">JOptionPane</span><span class="o">.</span><span class="na">ERROR_MESSAGE</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
            <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">showMessageDialog</span><span class="o">(</span><span class="nc">LoginFrame</span><span class="o">.</span><span class="na">this</span><span class="o">,</span>
                    <span class="s">"服务器内部错误，请稍后再试！！！"</span><span class="o">,</span><span class="s">"登录失败"</span><span class="o">,</span><span class="nc">JOptionPane</span><span class="o">.</span><span class="na">ERROR_MESSAGE</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></table></code></div></div><h3 id="registergui"><span class="mr-2">RegisterGUI</span><a href="#registergui" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>注册界面大致如下</p><p><img data-src="/assets/blog_res/2022-06-16-client.assets/5.png" alt="" data-proofer-ignore></p><div class="language-java highlighter-rouge"><div class="code-header"> <span data-label-text="Java"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="已复制！"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RegisterGUI</span> <span class="kd">extends</span> <span class="nc">JFrame</span><span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">768631070458723803L</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">JPasswordField</span> <span class="n">pwdFld</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">JPasswordField</span> <span class="n">pwd2Fld</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">JTextField</span> <span class="n">nickname</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">JComboBox</span> <span class="n">head</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">JRadioButton</span> <span class="n">sex0</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">JRadioButton</span> <span class="n">sex1</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">JButton</span> <span class="n">ok</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">JButton</span> <span class="n">reset</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">JButton</span> <span class="n">cancel</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">RegisterFrame</span><span class="o">(){</span>
        <span class="k">this</span><span class="o">.</span><span class="na">init</span><span class="o">();</span>
        <span class="n">setVisible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(){</span>
        <span class="k">this</span><span class="o">.</span><span class="na">setTitle</span><span class="o">(</span><span class="s">"注册新账号"</span><span class="o">);</span>
        <span class="n">setBounds</span><span class="o">((</span><span class="nc">DataBuffer</span><span class="o">.</span><span class="na">screenSize</span><span class="o">.</span><span class="na">width</span> <span class="o">-</span> <span class="mi">387</span><span class="o">)/</span><span class="mi">2</span><span class="o">,</span>
                <span class="o">(</span><span class="nc">DataBuffer</span><span class="o">.</span><span class="na">screenSize</span><span class="o">.</span><span class="na">height</span> <span class="o">-</span> <span class="mi">267</span><span class="o">)/</span><span class="mi">2</span><span class="o">,</span>
                <span class="mi">387</span><span class="o">,</span> <span class="mi">267</span><span class="o">);</span>
        <span class="n">getContentPane</span><span class="o">().</span><span class="na">setLayout</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
        <span class="n">setResizable</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

        <span class="nc">JLabel</span> <span class="n">lable</span> <span class="o">=</span><span class="k">new</span> <span class="nc">JLabel</span><span class="o">(</span><span class="s">"昵称"</span><span class="o">);</span><span class="c1">//label显示</span>
        <span class="n">lable</span><span class="o">.</span><span class="na">setBounds</span><span class="o">(</span><span class="mi">24</span><span class="o">,</span><span class="mi">35</span><span class="o">,</span><span class="mi">59</span><span class="o">,</span><span class="mi">17</span><span class="o">);</span>
        <span class="n">getContentPane</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">lable</span><span class="o">);</span>

        <span class="n">nickname</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JTextField</span><span class="o">();</span> <span class="c1">//昵称</span>
        <span class="n">nickname</span><span class="o">.</span><span class="na">setBounds</span><span class="o">(</span><span class="mi">90</span><span class="o">,</span> <span class="mi">34</span><span class="o">,</span> <span class="mi">110</span><span class="o">,</span> <span class="mi">22</span><span class="o">);</span>
        <span class="n">getContentPane</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">nickname</span><span class="o">);</span>

        <span class="nc">JLabel</span> <span class="n">label5</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JLabel</span><span class="o">(</span><span class="s">"密码: *"</span><span class="o">);</span>
        <span class="n">label5</span><span class="o">.</span><span class="na">setBounds</span><span class="o">(</span><span class="mi">24</span><span class="o">,</span> <span class="mi">72</span><span class="o">,</span> <span class="mi">50</span><span class="o">,</span> <span class="mi">17</span><span class="o">);</span>
        <span class="n">getContentPane</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">label5</span><span class="o">);</span>

        <span class="nc">JLabel</span> <span class="n">label3</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JLabel</span><span class="o">(</span><span class="s">"确认密码: *"</span><span class="o">);</span>
        <span class="n">label3</span><span class="o">.</span><span class="na">setBounds</span><span class="o">(</span><span class="mi">24</span><span class="o">,</span> <span class="mi">107</span><span class="o">,</span> <span class="mi">65</span><span class="o">,</span> <span class="mi">17</span><span class="o">);</span>
        <span class="n">getContentPane</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">label3</span><span class="o">);</span>

        <span class="n">pwdFld</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JPasswordField</span><span class="o">();</span> <span class="c1">//密码框</span>
        <span class="n">pwdFld</span><span class="o">.</span><span class="na">setBounds</span><span class="o">(</span><span class="mi">90</span><span class="o">,</span> <span class="mi">70</span><span class="o">,</span> <span class="mi">110</span><span class="o">,</span> <span class="mi">22</span><span class="o">);</span>
        <span class="n">getContentPane</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">pwdFld</span><span class="o">);</span>

        <span class="n">pwd2Fld</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JPasswordField</span><span class="o">();</span> <span class="c1">//确认密码框</span>
        <span class="n">pwd2Fld</span><span class="o">.</span><span class="na">setBounds</span><span class="o">(</span><span class="mi">90</span><span class="o">,</span> <span class="mi">105</span><span class="o">,</span> <span class="mi">110</span><span class="o">,</span> <span class="mi">22</span><span class="o">);</span>
        <span class="n">getContentPane</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">pwd2Fld</span><span class="o">);</span>

        <span class="nc">JLabel</span> <span class="n">label4</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JLabel</span><span class="o">(</span><span class="s">"性别:"</span><span class="o">);</span>
        <span class="n">label4</span><span class="o">.</span><span class="na">setBounds</span><span class="o">(</span><span class="mi">230</span><span class="o">,</span> <span class="mi">36</span><span class="o">,</span> <span class="mi">31</span><span class="o">,</span> <span class="mi">17</span><span class="o">);</span>
        <span class="n">getContentPane</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">label4</span><span class="o">);</span>

        <span class="n">sex1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JRadioButton</span><span class="o">(</span><span class="s">"女"</span><span class="o">,</span><span class="kc">true</span><span class="o">);</span> <span class="c1">//性别选项</span>
        <span class="n">sex1</span><span class="o">.</span><span class="na">setBounds</span> <span class="o">(</span><span class="mi">268</span><span class="o">,</span> <span class="mi">31</span><span class="o">,</span><span class="mi">44</span><span class="o">,</span> <span class="mi">25</span><span class="o">);</span>
        <span class="n">getContentPane</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">sex1</span><span class="o">);</span>
        <span class="n">sex0</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JRadioButton</span><span class="o">(</span><span class="s">"男"</span><span class="o">);</span>
        <span class="n">sex0</span><span class="o">.</span><span class="na">setBounds</span><span class="o">(</span><span class="mi">310</span><span class="o">,</span> <span class="mi">31</span><span class="o">,</span> <span class="mi">44</span><span class="o">,</span> <span class="mi">25</span><span class="o">);</span>
        <span class="n">getContentPane</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">sex0</span><span class="o">);</span>

        <span class="nc">ButtonGroup</span> <span class="n">buttonGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ButtonGroup</span><span class="o">();</span> <span class="c1">//单选按钮组</span>
        <span class="n">buttonGroup</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">sex0</span><span class="o">);</span>
        <span class="n">buttonGroup</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">sex1</span><span class="o">);</span>

        <span class="nc">JLabel</span> <span class="n">label6</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JLabel</span><span class="o">(</span><span class="s">"头像:"</span><span class="o">);</span>
        <span class="n">label6</span><span class="o">.</span><span class="na">setBounds</span><span class="o">(</span><span class="mi">230</span><span class="o">,</span> <span class="mi">72</span><span class="o">,</span> <span class="mi">31</span><span class="o">,</span> <span class="mi">17</span><span class="o">);</span>
        <span class="n">getContentPane</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">label6</span><span class="o">);</span>

        <span class="n">head</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JComboBox</span><span class="o">();</span> <span class="c1">//下拉列表图标</span>
        <span class="n">head</span><span class="o">.</span><span class="na">setBounds</span><span class="o">(</span><span class="mi">278</span><span class="o">,</span> <span class="mi">70</span><span class="o">,</span> <span class="mi">65</span><span class="o">,</span> <span class="mi">45</span><span class="o">);</span>
        <span class="n">head</span><span class="o">.</span><span class="na">setMaximumRowCount</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">head</span><span class="o">.</span><span class="na">addItem</span><span class="o">(</span><span class="k">new</span> <span class="nc">ImageIcon</span><span class="o">(</span><span class="s">"images/"</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">".png"</span><span class="o">));</span>
            <span class="c1">//通过循环添加图片 注意图片名字要取成1,2,3,4,5,等</span>
        <span class="o">}</span>
        <span class="n">head</span><span class="o">.</span><span class="na">setSelectedIndex</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="n">getContentPane</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">head</span><span class="o">);</span>

        <span class="c1">//按钮</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JButton</span><span class="o">(</span><span class="s">"确认"</span><span class="o">);</span>
        <span class="n">ok</span><span class="o">.</span><span class="na">setBounds</span><span class="o">(</span><span class="mi">27</span><span class="o">,</span> <span class="mi">176</span><span class="o">,</span> <span class="mi">60</span><span class="o">,</span> <span class="mi">28</span><span class="o">);</span>
        <span class="n">getContentPane</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">ok</span><span class="o">);</span>

        <span class="n">reset</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JButton</span><span class="o">(</span><span class="s">"重填"</span><span class="o">);</span>
        <span class="n">reset</span><span class="o">.</span><span class="na">setBounds</span><span class="o">(</span><span class="mi">123</span><span class="o">,</span> <span class="mi">176</span><span class="o">,</span> <span class="mi">60</span><span class="o">,</span> <span class="mi">28</span><span class="o">);</span>
        <span class="n">getContentPane</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">reset</span><span class="o">);</span>

        <span class="n">cancel</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JButton</span><span class="o">(</span><span class="s">"取消"</span><span class="o">);</span>
        <span class="n">cancel</span><span class="o">.</span><span class="na">setBounds</span><span class="o">(</span><span class="mi">268</span><span class="o">,</span> <span class="mi">176</span><span class="o">,</span> <span class="mi">60</span><span class="o">,</span> <span class="mi">28</span><span class="o">);</span>
        <span class="n">getContentPane</span><span class="o">().</span><span class="na">add</span><span class="o">(</span><span class="n">cancel</span><span class="o">);</span>

        <span class="cm">/*---------注册事件监听器----------*/</span>
        <span class="c1">//取消按钮监听事件处理</span>
        <span class="n">cancel</span><span class="o">.</span><span class="na">addActionListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">ActionListener</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">actionPerformed</span><span class="o">(</span><span class="kd">final</span> <span class="nc">ActionEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">RegisterFrame</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">dispose</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="c1">//关闭窗口</span>
        <span class="k">this</span><span class="o">.</span><span class="na">addWindowListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">WindowAdapter</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">windowClosing</span><span class="o">(</span><span class="nc">WindowEvent</span> <span class="n">e</span><span class="o">){</span>
                <span class="nc">RegisterFrame</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">dispose</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">});</span>

        <span class="c1">// 重置按钮监听事件处理</span>
        <span class="n">reset</span><span class="o">.</span><span class="na">addActionListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">ActionListener</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">actionPerformed</span><span class="o">(</span><span class="kd">final</span> <span class="nc">ActionEvent</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">nickname</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
                <span class="n">pwdFld</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
                <span class="n">pwd2Fld</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
                <span class="n">nickname</span><span class="o">.</span><span class="na">requestFocusInWindow</span><span class="o">();</span> <span class="c1">//用户名获得焦点</span>
            <span class="o">}</span>
        <span class="o">});</span>

        <span class="c1">//确认按钮监听事件处理</span>
        <span class="n">ok</span><span class="o">.</span><span class="na">addActionListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">ActionListener</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">actionPerformed</span><span class="o">(</span><span class="kd">final</span> <span class="nc">ActionEvent</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">pwdFld</span><span class="o">.</span><span class="na">getPassword</span><span class="o">().</span><span class="na">length</span><span class="o">==</span><span class="mi">0</span> <span class="o">||</span> <span class="n">pwd2Fld</span><span class="o">.</span><span class="na">getPassword</span><span class="o">().</span><span class="na">length</span><span class="o">==</span><span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">showMessageDialog</span><span class="o">(</span><span class="nc">RegisterFrame</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="s">"带 “ * ” 为必填内容!"</span><span class="o">);</span>
                    <span class="c1">//判断用户名和密码是否为空</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">pwdFld</span><span class="o">.</span><span class="na">getPassword</span><span class="o">()).</span><span class="na">equals</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">pwd2Fld</span><span class="o">.</span><span class="na">getPassword</span><span class="o">())))</span> <span class="o">{</span>
                    <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">showMessageDialog</span><span class="o">(</span><span class="nc">RegisterFrame</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="s">"两次输入密码不一致!"</span><span class="o">);</span>
                    <span class="n">pwdFld</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
                    <span class="n">pwd2Fld</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
                    <span class="n">pwdFld</span><span class="o">.</span><span class="na">requestFocusInWindow</span><span class="o">();</span>
                    <span class="c1">//判断两次密码是否一致</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">pwdFld</span><span class="o">.</span><span class="na">getPassword</span><span class="o">()),</span>
                            <span class="n">nickname</span><span class="o">.</span><span class="na">getText</span><span class="o">(),</span>
                            <span class="n">sex0</span><span class="o">.</span><span class="na">isSelected</span><span class="o">()</span> <span class="o">?</span> <span class="sc">'m'</span> <span class="o">:</span> <span class="sc">'f'</span><span class="o">,</span>
                            <span class="n">head</span><span class="o">.</span><span class="na">getSelectedIndex</span><span class="o">());</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="nc">RegisterFrame</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">regist</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e1</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">e1</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ClassNotFoundException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">ex</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="c1">//注册</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">regist</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ClassNotFoundException</span><span class="o">{</span>
        <span class="nc">Request</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Request</span><span class="o">();</span>
        <span class="n">request</span><span class="o">.</span><span class="na">setAction</span><span class="o">(</span><span class="s">"userRegist"</span><span class="o">);</span>
        <span class="n">request</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"user"</span><span class="o">,</span><span class="n">user</span><span class="o">);</span>

        <span class="c1">//获得响应</span>
        <span class="nc">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="nc">ClientUtil</span><span class="o">.</span><span class="na">sendTextRequest</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>

        <span class="nc">ResponseStatus</span> <span class="n">status</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="na">getStatus</span><span class="o">();</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">status</span><span class="o">){</span>
            <span class="k">case</span> <span class="nl">OK:</span>
                <span class="nc">User</span> <span class="n">user2</span> <span class="o">=</span> <span class="o">(</span><span class="nc">User</span><span class="o">)</span><span class="n">response</span><span class="o">.</span><span class="na">getData</span><span class="o">(</span><span class="s">"user"</span><span class="o">);</span>
                <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">showMessageDialog</span><span class="o">(</span><span class="nc">RegisterFrame</span><span class="o">.</span><span class="na">this</span><span class="o">,</span>
                        <span class="s">"注册成功，您的账号为 :"</span><span class="o">+</span> <span class="n">user2</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">",请牢记!!!"</span><span class="o">,</span>
                        <span class="s">"注册成功"</span><span class="o">,</span><span class="nc">JOptionPane</span><span class="o">.</span><span class="na">INFORMATION_MESSAGE</span><span class="o">);</span>
                <span class="k">this</span><span class="o">.</span><span class="na">setVisible</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="k">default</span><span class="o">:</span>
                <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">showMessageDialog</span><span class="o">(</span><span class="nc">RegisterFrame</span><span class="o">.</span><span class="na">this</span><span class="o">,</span>
                        <span class="s">"注册失败，请稍后再试！！！"</span><span class="o">,</span>
                        <span class="s">"服务器内部错误！"</span><span class="o">,</span>
                        <span class="nc">JOptionPane</span><span class="o">.</span><span class="na">ERROR_MESSAGE</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="运行结果"><span class="mr-2">运行结果</span><a href="#运行结果" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><img data-src="/assets/blog_res/2022-06-16-client.assets/image-20220617212942266.png" alt="image-20220617212942266" data-proofer-ignore></p><p><img data-src="/assets/blog_res/2022-06-16-client.assets/image-20220616213924955.png" alt="image-20220616213924955" data-proofer-ignore></p><p><img data-src="/assets/blog_res/2022-06-16-client.assets/image-20220616213937823.png" alt="image-20220616213937823" data-proofer-ignore></p><p><img data-src="/assets/blog_res/2022-06-16-client.assets/image-20220616214003527.png" alt="image-20220616214003527" data-proofer-ignore></p><p>基本完成，除了不够美观。</p><p>个人认为项目的难点是在客户端，之前考虑了很久关于界面的切换，因为涉及到了登陆界面、注册界面、聊天界面，所以如何将客户端的socket与这几个界面联系起来是个值得思考的问题。同时，也思考了好久好友列表的展示方法，最后参考了别人的设计方法。</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%E8%AF%BE%E8%AE%BE/'>课设</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/java/" class="post-tag no-text-decoration" >Java</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> 本文由作者按照 <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> 进行授权</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">分享</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=JAVA-Socket%E9%80%9A%E4%BF%A1+%E8%81%8A%E5%A4%A9%E5%AE%A4%EF%BC%88%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%89+-+Aye486&url=%2Fposts%2Fclient%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=JAVA-Socket%E9%80%9A%E4%BF%A1+%E8%81%8A%E5%A4%A9%E5%AE%A4%EF%BC%88%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%89+-+Aye486&u=%2Fposts%2Fclient%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Fclient%2F&text=JAVA-Socket%E9%80%9A%E4%BF%A1+%E8%81%8A%E5%A4%A9%E5%AE%A4%EF%BC%88%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%89+-+Aye486" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="分享链接" data-title-succeed="链接已复制！"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">最近更新</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/plane-war/">飞机大战</a><li><a href="/posts/hello-world/">你好，世界！</a><li><a href="/posts/%E5%8D%8F%E7%A8%8B%E5%92%8Clibco/">协程简介</a><li><a href="/posts/client/">JAVA-Socket通信 聊天室（客户端）</a><li><a href="/posts/Service/">JAVA-Socket通信 聊天室（服务端）</a></ul></div><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/%E7%AE%97%E6%B3%95/">算法</a> <a class="post-tag" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a> <a class="post-tag" href="/tags/game/">Game</a> <a class="post-tag" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/">计算机基础</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">文章内容</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>相关文章</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/common/"><div class="card-body"> <em class="small" data-ts="1655298120" data-df="YYYY-MM-DD" > 2022-06-15 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>JAVA-Socket通信 聊天室（工具类）</h3><div class="text-muted small"><p> 关于聊天室中工具类部分 整体思路 把要传输的内容封装成了两个类 Response 和 Request，客户端向服务器发起请求，服务器向客户端回应，通过两个类中包含的请求类型来判断需要进行的操作，传输采用ObjectStream。仔细以看其实会发现，这两个类内容很相似。 Request public class Request implements Serializable { ...</p></div></div></a></div><div class="card"> <a href="/posts/chartroom/"><div class="card-body"> <em class="small" data-ts="1655298120" data-df="YYYY-MM-DD" > 2022-06-15 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>JAVA-Socket通信 聊天室</h3><div class="text-muted small"><p> 聊天室曾经盛行一时，今天我们就用简单的java代码来复刻他。 一、项目名称 聊天室 二、功能介绍 用Java图形用户界面编写聊天室服务器端和客户端， 支持多个客户端连接到一个服务器。每个客户端能够输入账号，包括注册功能。 可以实现群聊（聊天记录显示在所有客户端界面）。 完成好友列表在各个客户端上显示，包括头像和用户名。 ...</p></div></div></a></div><div class="card"> <a href="/posts/Service/"><div class="card-body"> <em class="small" data-ts="1655298120" data-df="YYYY-MM-DD" > 2022-06-15 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>JAVA-Socket通信 聊天室（服务端）</h3><div class="text-muted small"><p> 关于聊天室中服务器部分 一个聊天室，我们可以将其分为服务端和客户端，而通信的简易过程如下图所示 对于服务器，我们需要做的是1、验证用户登陆信息。2、接收用户发送的信息并转发给目标用户 整体思路 Server端 UserService 用于用户账号管理，预先创建几个账号，然后存到文件中，每次服务器执行时，都会将文件中的账号信息读入，同时新创建的用户账号也会存入到文件中去。 ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Service/" class="btn btn-outline-primary" prompt="上一篇"><p>JAVA-Socket通信 聊天室（服务端）</p></a> <a href="/posts/%E5%8D%8F%E7%A8%8B%E5%92%8Clibco/" class="btn btn-outline-primary" prompt="下一篇"><p>协程简介</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/Aye486">Aye486</a>. <span data-toggle="tooltip" data-placement="top" title="除非另有说明，本网站上的博客文章均由作者按照知识共享署名 4.0 国际 (CC BY 4.0) 许可协议进行授权。">保留部分权利。</span></p></div><div class="footer-right"><p class="mb-0"> 本站由 <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> 生成，采用 <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> 主题。</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">热门标签</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/%E7%AE%97%E6%B3%95/">算法</a> <a class="post-tag" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a> <a class="post-tag" href="/tags/game/">Game</a> <a class="post-tag" href="/tags/%E7%94%9F%E6%B4%BB/">生活</a> <a class="post-tag" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/">计算机基础</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3"></p><button type="button" class="btn btn-primary" aria-label="Update"> </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">搜索结果为空</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/asia/jinan.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
